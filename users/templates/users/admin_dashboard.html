{% extends 'users/base.html' %}
{% load static %}

{% block title %}Admin Dashboard - FoodOrdering{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<!-- Admin Dashboard -->
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 admin-sidebar p-0">
            <div class="p-3">
                <h5 class="fw-bold mb-4">
                    <ion-icon name="settings-outline" class="me-2"></ion-icon>
                    Admin Panel
                </h5>
                <nav class="nav flex-column">
                    <a class="nav-link active fw-medium admin-nav-link" href="#dashboard" data-section="dashboard" id="dashboardNavLink">
                        <ion-icon name="grid-outline" class="me-2"></ion-icon>
                        Dashboard
                        <span class="badge bg-primary ms-auto">{{ total_users|add:total_restaurants|add:total_orders }}</span>
                    </a>
                <script>
                // Store the initial comprehensive dashboard view on first load
                document.addEventListener('DOMContentLoaded', function() {
                    // Find the comprehensive view content (assuming it has a unique id or data attribute)
                    var comprehensiveView = document.getElementById('dashboard-section');
                    if (comprehensiveView) {
                        window._comprehensiveDashboardContent = comprehensiveView.innerHTML;
                    }
                });

                function showComprehensiveDashboardView(e) { e.preventDefault(); window.location.hash = '#dashboard'; }
                </script>
                    <a class="nav-link fw-medium admin-nav-link" href="#users" data-section="users">
                        <ion-icon name="people-outline" class="me-2"></ion-icon>
                        User Management
                        <span class="badge bg-success ms-auto">{{ total_users }}</span>
                    </a>
                    <a class="nav-link fw-medium admin-nav-link" href="#restaurants" data-section="restaurants">
                        <ion-icon name="restaurant-outline" class="me-2"></ion-icon>
                        Restaurants
                        <span class="badge bg-warning ms-auto">{{ total_restaurants }}</span>
                    </a>
                    <a class="nav-link fw-medium admin-nav-link" href="#orders" data-section="orders">
                        <ion-icon name="receipt-outline" class="me-2"></ion-icon>
                        Orders
                        <span class="badge bg-info ms-auto">{{ total_orders }}</span>
                    </a>
                    <a class="nav-link fw-medium admin-nav-link" href="#meals" data-section="meals">
                        <ion-icon name="fast-food-outline" class="me-2"></ion-icon>
                        Meals
                        <span class="badge bg-secondary ms-auto">{{ total_meals }}</span>
                    </a>
                    <a class="nav-link fw-medium admin-nav-link" href="#analytics" data-section="analytics">
                        <ion-icon name="bar-chart-outline" class="me-2"></ion-icon>
                        Analytics
                    </a>
                    <a class="nav-link fw-medium admin-nav-link" href="#settings" data-section="settings">
                        <ion-icon name="cog-outline" class="me-2"></ion-icon>
                        Settings
                    </a>
                    <a class="nav-link fw-medium" href="{% url 'users:home' %}">
                        <ion-icon name="arrow-back-outline" class="me-2"></ion-icon>
                        Back to Site
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 admin-content">
            <!-- Admin Header -->
            <div class="admin-header">
                <div class="container-fluid">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" id="simpleViewBtn" onclick="toggleView('simple')">
                                    <ion-icon name="grid-outline" class="me-1"></ion-icon>
                                    Simple View
                                </button>
                                <button type="button" class="btn btn-primary" id="comprehensiveViewBtn" onclick="toggleView('comprehensive')">
                                    <ion-icon name="layers-outline" class="me-1"></ion-icon>
                                    Comprehensive View
                                </button>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex align-items-center">
                                <span class="text-body-secondary me-3">Welcome, {{ user.username }}</span>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <ion-icon name="person-circle-outline" class="me-1"></ion-icon>
                                        {{ user.username }}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{% url 'users:profile' %}">Profile</a></li>
                                        <li><a class="dropdown-item" href="#settings">Settings</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="{% url 'users:logout' %}">Logout</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="container-fluid py-4">
                <!-- Dashboard Section (Default) -->
                <div id="dashboard-section" class="admin-section">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="stats-card">
                            <div class="d-flex align-items-center">
                                <div class="stats-icon bg-primary me-3">
                                    <ion-icon name="people"></ion-icon>
                                </div>
                                <div>
                                    <h3 class="fw-bold mb-0">{{ total_users }}</h3>
                                    <p class="text-body-secondary mb-0">Total Users</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stats-card">
                            <div class="d-flex align-items-center">
                                <div class="stats-icon bg-success me-3">
                                    <ion-icon name="restaurant"></ion-icon>
                                </div>
                                <div>
                                    <h3 class="fw-bold mb-0">{{ total_restaurants }}</h3>
                                    <p class="text-body-secondary mb-0">Restaurants</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stats-card">
                            <div class="d-flex align-items-center">
                                <div class="stats-icon bg-warning me-3">
                                    <ion-icon name="receipt"></ion-icon>
                                </div>
                                <div>
                                    <h3 class="fw-bold mb-0">{{ total_orders }}</h3>
                                    <p class="text-body-secondary mb-0">Total Orders</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stats-card">
                            <div class="d-flex align-items-center">
                                <div class="stats-icon bg-info me-3">
                                    <ion-icon name="cash"></ion-icon>
                                </div>
                                <div>
                                    <h3 class="fw-bold mb-0">${{ total_revenue }}</h3>
                                    <p class="text-body-secondary mb-0">Revenue</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div class="settings-section">
                    <h4 class="mb-4">
                        <ion-icon name="people-outline" class="me-2"></ion-icon>
                        User Management
                        <span class="badge bg-primary ms-2">{{ users|length }}</span>
                    </h4>
                    
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select filter-dropdown" id="dashboardRoleFilter" name="dashboardRoleFilter">
                                <option value="">All Roles</option>
                                <option value="customer">Customer</option>
                                <option value="owner">Restaurant Owner</option>
                                <option value="delivery">Delivery Person</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select filter-dropdown" id="dashboardStatusFilter" name="dashboardStatusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="dashboardUserSearch" name="dashboardUserSearch" placeholder="Search users...">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchDashboardUsers()">
                                    <ion-icon name="search"></ion-icon>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="user-table">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr data-role="{{ user.role }}" data-status="{{ user.is_active|yesno:'active,inactive' }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <ion-icon name="person-circle-outline" class="me-2" style="font-size: 1.5rem; color: var(--bs-primary);"></ion-icon>
                                            <div>
                                                <h6 class="mb-0 fw-bold">{{ user.username }}</h6>
                                                <small class="text-body-secondary">{{ user.get_full_name|default:"No name" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        <span class="badge bg-{% if user.role == 'admin' %}danger{% elif user.role == 'owner' %}warning{% elif user.role == 'delivery' %}info{% else %}success{% endif %}">
                                            {{ user.get_role_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge {% if user.is_active %}status-active{% else %}status-inactive{% endif %}">
                                            {% if user.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary edit-user-btn" 
                                                    data-user-id="{{ user.id }}" 
                                                    data-user-name="{{ user.username }}"
                                                    title="Edit User">
                                            <ion-icon name="create-outline"></ion-icon>
                                        </button>
                                            <button class="btn btn-sm btn-outline-warning toggle-user-status-btn" 
                                                    data-user-id="{{ user.id }}" 
                                                    data-user-name="{{ user.username }}"
                                                    data-is-active="{{ user.is_active|yesno:'true,false' }}"
                                                    title="Toggle Status">
                                                <ion-icon name="{% if user.is_active %}eye-off-outline{% else %}eye-outline{% endif %}"></ion-icon>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-user-btn" 
                                                    data-user-id="{{ user.id }}" 
                                                    data-user-name="{{ user.username }}"
                                                    title="Delete User">
                                            <ion-icon name="trash-outline"></ion-icon>
                                        </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Platform Settings Section -->
                <div class="settings-section">
                    <h4>Platform - Settings</h4>
                    <h6 class="text-body-secondary mb-3">Platform Information</h6>
                    
                    <form id="platformSettingsForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="siteName" name="siteName" placeholder="Site Name" value="">
                                    <label for="siteName">Site Name</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="contactEmail" name="contactEmail" placeholder="Contact Email" value="">
                                    <label for="contactEmail">Contact Email</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-floating">
                                <textarea class="form-control" id="siteDescription" name="siteDescription" style="height: 100px" placeholder="About / Description"></textarea>
                                <label for="siteDescription">About / Description</label>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-floating">
                                    <input type="tel" class="form-control" id="supportPhone" name="supportPhone" placeholder="Support Phone Number" value="">
                                    <label for="supportPhone">Support Phone Number</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="supportEmail" name="supportEmail" placeholder="Support Email" value="">
                                    <label for="supportEmail">Support Email</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="defaultDeliveryFee" name="defaultDeliveryFee" placeholder="Default Delivery Fee" step="0.01" min="0" value="">
                                    <label for="defaultDeliveryFee">Default Delivery Fee ($)</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="freeDeliveryThreshold" name="freeDeliveryThreshold" placeholder="Free Delivery Threshold" step="0.01" min="0" value="">
                                    <label for="freeDeliveryThreshold">Free Delivery Threshold ($)</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-end">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="loadPlatformSettings()">
                                <ion-icon name="refresh-outline" class="me-1"></ion-icon>
                                Refresh
                            </button>
                            <button type="button" class="btn btn-primary" onclick="savePlatformSettings()">
                                <ion-icon name="save-outline" class="me-1"></ion-icon>
                                Save Settings
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Recent Orders Section -->
                <div class="settings-section">
                    <h4 class="mb-4">
                        <ion-icon name="receipt-outline" class="me-2"></ion-icon>
                        Recent Orders
                        <span class="badge bg-success ms-2">{{ recent_orders|length }}</span>
                    </h4>
                    
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Restaurant</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in recent_orders %}
                                <tr>
                                    <td><span class="fw-bold">#{{ order.id }}</span></td>
                                    <td>{{ order.user.username }}</td>
                                    <td>{{ order.restaurant.name|default:"N/A" }}</td>
                                    <td class="fw-bold text-success">${{ order.total_amount }}</td>
                                    <td>
                                        <span class="badge bg-{% if order.status == 'delivered' %}success{% elif order.status == 'confirmed' %}warning{% elif order.status == 'cancelled' %}danger{% else %}info{% endif %}">
                                            {{ order.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ order.created_at|date:"M d, Y" }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary edit-order-btn" 
                                                    data-order-id="{{ order.id }}" 
                                                    title="Edit Order">
                                                <ion-icon name="create-outline"></ion-icon>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info update-order-status-btn" 
                                                    data-order-id="{{ order.id }}" 
                                                    data-current-status="{{ order.status }}"
                                                    title="Update Status">
                                                <ion-icon name="refresh-outline"></ion-icon>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-order-btn" 
                                                    data-order-id="{{ order.id }}" 
                                                    title="Delete Order">
                                                <ion-icon name="trash-outline"></ion-icon>
                                            </button>
            </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-body-secondary py-4">
                                        <ion-icon name="receipt-outline" style="font-size: 48px; color: #ccc;" class="mb-3 d-block"></ion-icon>
                                        <p class="mb-0">No orders yet</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                </div> <!-- End Dashboard Section -->
                
                <!-- Simple View Section (Hidden by default) -->
                <div id="simple-view-section" class="admin-section" style="display: none;">
                    <!-- Simple Overview Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <ion-icon name="people" style="font-size: 2rem;" class="mb-2"></ion-icon>
                                    <h3 class="fw-bold mb-0">{{ total_users }}</h3>
                                    <p class="mb-0">Total Users</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <ion-icon name="restaurant" style="font-size: 2rem;" class="mb-2"></ion-icon>
                                    <h3 class="fw-bold mb-0">{{ total_restaurants }}</h3>
                                    <p class="mb-0">Restaurants</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <ion-icon name="receipt" style="font-size: 2rem;" class="mb-2"></ion-icon>
                                    <h3 class="fw-bold mb-0">{{ total_orders }}</h3>
                                    <p class="mb-0">Total Orders</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <ion-icon name="cash" style="font-size: 2rem;" class="mb-2"></ion-icon>
                                    <h3 class="fw-bold mb-0">${{ total_revenue }}</h3>
                                    <p class="mb-0">Revenue</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Simple Quick Actions -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <ion-icon name="flash-outline" class="me-2"></ion-icon>
                                        Quick Actions
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <button class="btn btn-outline-primary w-100" onclick="showSection('users')">
                                                <ion-icon name="people-outline" class="me-2"></ion-icon>
                                                Manage Users
                                            </button>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <button class="btn btn-outline-success w-100" onclick="showSection('restaurants')">
                                                <ion-icon name="restaurant-outline" class="me-2"></ion-icon>
                                                Manage Restaurants
                                            </button>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <button class="btn btn-outline-warning w-100" onclick="showSection('orders')">
                                                <ion-icon name="receipt-outline" class="me-2"></ion-icon>
                                                Manage Orders
                                            </button>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <button class="btn btn-outline-info w-100" onclick="showSection('settings')">
                                                <ion-icon name="settings-outline" class="me-2"></ion-icon>
                                                Platform Settings
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Simple Recent Activity -->
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <ion-icon name="people-outline" class="me-2"></ion-icon>
                                        Recent Users
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% for user in users|slice:":5" %}
                                    <div class="d-flex align-items-center mb-3">
                                        <ion-icon name="person-circle-outline" class="me-2" style="font-size: 1.5rem; color: var(--bs-primary);"></ion-icon>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0 fw-bold">{{ user.username }}</h6>
                                            <small class="text-body-secondary">{{ user.get_role_display }}</small>
                                        </div>
                                        <span class="badge bg-{% if user.is_active %}success{% else %}danger{% endif %}">
                                            {% if user.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <ion-icon name="receipt-outline" class="me-2"></ion-icon>
                                        Recent Orders
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% for order in recent_orders|slice:":5" %}
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <div>
                                            <h6 class="mb-0 fw-bold">Order #{{ order.id }}</h6>
                                            <small class="text-body-secondary">{{ order.user.username }}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="fw-bold text-success">${{ order.total_amount }}</span>
                                            <br>
                                            <span class="badge bg-{% if order.status == 'delivered' %}success{% elif order.status == 'confirmed' %}warning{% elif order.status == 'cancelled' %}danger{% else %}info{% endif %}">
                                                {{ order.get_status_display }}
                                            </span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Dashboard Styles -->
<style>
    :root {
        --primary-green: #198754;
        --secondary-green: #157347;
        --border-radius-sm: 0.375rem;
        --border-radius-md: 0.5rem;
        --shadow-md: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .admin-sidebar {
        min-height: 100vh;
        background: var(--bs-body-bg);
        border-right: 1px solid var(--bs-border-color);
    }
    
    .admin-content {
        min-height: 100vh;
        background: var(--bs-body-bg);
    }
    
    .admin-header {
        background: var(--bs-body-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 1rem 0;
    }
    
    .stats-card {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: var(--border-radius-md);
        padding: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .stats-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }
    
    .user-table {
        background: var(--bs-body-bg);
        border-radius: var(--border-radius-md);
        overflow: hidden;
    }
    
    .user-table th {
        background: var(--bs-secondary-bg);
        border-bottom: 2px solid var(--bs-border-color);
        font-weight: 600;
        color: var(--bs-body-color);
    }
    
    .user-table td {
        vertical-align: middle;
        border-bottom: 1px solid var(--bs-border-color);
        color: var(--bs-body-color);
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    
    .settings-section {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: var(--border-radius-md);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .settings-section h4 {
        color: var(--bs-body-color);
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--primary-green);
    }
    
    .form-floating > label {
        color: var(--bs-body-color);
    }
    
    .btn-save {
        background: var(--primary-green);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: var(--border-radius-md);
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-save:hover {
        background: var(--secondary-green);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .filter-dropdown {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: var(--border-radius-sm);
        padding: 0.5rem 1rem;
        color: var(--bs-body-color);
    }
    
    .filter-dropdown:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 0.2rem rgba(148, 216, 45, 0.25);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .admin-sidebar {
            min-height: auto;
            border-right: none;
            border-bottom: 1px solid var(--border-color);
        }
        
        .admin-content {
            padding-top: 1rem;
        }
        
        .stats-card {
            margin-bottom: 1rem;
        }
        
        .user-table {
            font-size: 0.875rem;
        }
        
        .settings-section {
            padding: 1rem;
        }
    }
    
    @media (max-width: 576px) {
        .admin-header .row {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .admin-header .col-auto {
            margin-top: 1rem;
        }
        
        .filter-dropdown {
            margin-bottom: 0.5rem;
        }
    }
    
    /* Admin Section Management */
    .admin-section {
        display: none;
    }
    
    .admin-section:first-child {
        display: block;
    }
    
    .admin-nav-link {
        transition: all 0.3s ease;
        border-radius: 0.375rem;
        margin-bottom: 0.25rem;
        color: var(--bs-body-color) !important;
    }
    
    /* Dark mode fixes for cards and containers */
    .card {
        background-color: var(--bs-body-bg) !important;
        border-color: var(--bs-border-color) !important;
    }
    
    .card-header {
        background-color: var(--bs-secondary-bg) !important;
        border-bottom-color: var(--bs-border-color) !important;
        color: var(--bs-body-color) !important;
    }
    
    .card-body {
        background-color: var(--bs-body-bg) !important;
        color: var(--bs-body-color) !important;
    }
    
    .table {
        --bs-table-bg: var(--bs-body-bg);
        --bs-table-color: var(--bs-body-color);
        --bs-table-border-color: var(--bs-border-color);
    }
    
    .form-control, .form-select {
        background-color: var(--bs-body-bg) !important;
        border-color: var(--bs-border-color) !important;
        color: var(--bs-body-color) !important;
    }
    
    .form-control:focus, .form-select:focus {
        background-color: var(--bs-body-bg) !important;
        border-color: var(--primary-green) !important;
        color: var(--bs-body-color) !important;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
    }
    
    .btn-outline-primary, .btn-outline-secondary, .btn-outline-success, .btn-outline-warning, .btn-outline-info, .btn-outline-danger {
        border-color: var(--bs-border-color) !important;
        color: var(--bs-body-color) !important;
    }
    
    .btn-outline-primary:hover, .btn-outline-secondary:hover, .btn-outline-success:hover, .btn-outline-warning:hover, .btn-outline-info:hover, .btn-outline-danger:hover {
        background-color: var(--bs-secondary-bg) !important;
        border-color: var(--bs-border-color) !important;
        color: var(--bs-body-color) !important;
    }
    
    .admin-nav-link:hover {
        background-color: var(--bs-secondary-bg);
        transform: translateX(5px);
        color: var(--bs-body-color) !important;
    }
    
    .admin-nav-link.active {
        background-color: var(--primary-green);
        color: white !important;
    }
    
    .admin-nav-link.active .badge {
        background-color: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
    }
</style>

<!-- Admin Dashboard JS -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸŽ›ï¸ Admin Dashboard loaded');
        
        // Load platform settings on page load
        loadPlatformSettings();
        
        // Deep link handling: if URL has a hash, navigate to that section on first load
        const initialHash = (window.location.hash || '').replace('#', '').trim();
        if (initialHash) {
            showAdminSection(initialHash);
        }
        
        // User table row selection
        const tableRows = document.querySelectorAll('.user-table tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('click', function() {
                // Remove active class from all rows
                tableRows.forEach(r => r.classList.remove('table-active'));
                // Add active class to clicked row
                this.classList.add('table-active');
            });
        });
        
        // Save button functionality
        const saveButtons = document.querySelectorAll('.btn-save');
        saveButtons.forEach(button => {
            button.addEventListener('click', function() {
                const section = this.closest('.settings-section');
                const sectionName = section.querySelector('h4').textContent;
                
                // Show success message
                showNotification(`${sectionName} saved successfully!`, 'success');
                
                // Add loading state
                this.innerHTML = '<ion-icon name="hourglass-outline" class="me-1"></ion-icon>Saving...';
                this.disabled = true;
                
                // Reset after 2 seconds
                setTimeout(() => {
                    this.innerHTML = '<ion-icon name="save-outline" class="me-1"></ion-icon>Save';
                    this.disabled = false;
                }, 2000);
            });
        });
        
        // Filter functionality
        const filterDropdowns = document.querySelectorAll('.filter-dropdown');
        filterDropdowns.forEach(dropdown => {
            dropdown.addEventListener('change', function() {
                console.log('Filter changed:', this.value);
                // Implement filtering logic here
            });
        });
        
        // Dynamic Sidebar Navigation
        const adminNavLinks = document.querySelectorAll('.admin-nav-link');
        adminNavLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links
                adminNavLinks.forEach(l => l.classList.remove('active'));
                // Add active class to clicked link
                this.classList.add('active');
                
                // Get section name
                const section = this.getAttribute('data-section');
                showAdminSection(section);
            });
        });
        
        // User Management Actions
        const editUserBtns = document.querySelectorAll('.edit-user-btn');
        editUserBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const userName = this.getAttribute('data-user-name');
                showUserEditModal(userId, userName);
            });
        });
        
        const toggleUserStatusBtns = document.querySelectorAll('.toggle-user-status-btn');
        toggleUserStatusBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const userName = this.getAttribute('data-user-name');
                const isActive = this.getAttribute('data-is-active') === 'true';
                toggleUserStatus(userId, userName, isActive);
            });
        });
        
        const deleteUserBtns = document.querySelectorAll('.delete-user-btn');
        deleteUserBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const userName = this.getAttribute('data-user-name');
                deleteUser(userId, userName);
            });
        });
        
        // Order Management Actions
        const editOrderBtns = document.querySelectorAll('.edit-order-btn');
        editOrderBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                showOrderEditModal(orderId);
            });
        });
        
        const updateOrderStatusBtns = document.querySelectorAll('.update-order-status-btn');
        updateOrderStatusBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                const currentStatus = this.getAttribute('data-current-status');
                showOrderStatusModal(orderId, currentStatus);
            });
        });
        
        const deleteOrderBtns = document.querySelectorAll('.delete-order-btn');
        deleteOrderBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                deleteOrder(orderId);
            });
        });
    });
    
    // Get CSRF token function
    function getCSRFToken() {
        // Try to get from meta tag first
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken) {
            return metaToken.getAttribute('content');
        }
        
        // Fallback to cookie
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        
        return null;
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // User Management Functions
    function showUserEditModal(userId, userName) {
        // Fetch user data and show edit modal
        fetch(`/admin-api/users/${userId}/edit/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showUserEditForm(data.user);
            } else {
                showNotification(data.error || 'Failed to load user data', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to load user data', 'error');
        });
    }
    
    function showUserEditForm(user) {
        const modalHtml = `
            <div class="modal fade" id="userEditModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit User: ${user.username}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="userEditForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Username</label>
                                        <input type="text" class="form-control" id="editUsername" value="${user.username}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="editEmail" value="${user.email}">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="editFirstName" value="${user.first_name || ''}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="editLastName" value="${user.last_name || ''}">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Role</label>
                                        <select class="form-select" id="editRole">
                                            <option value="customer" ${user.role === 'customer' ? 'selected' : ''}>Customer</option>
                                            <option value="owner" ${user.role === 'owner' ? 'selected' : ''}>Owner</option>
                                            <option value="delivery" ${user.role === 'delivery' ? 'selected' : ''}>Delivery</option>
                                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="editIsActive" ${user.is_active ? 'checked' : ''}>
                                            <label class="form-check-label">Active Account</label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveUserEdit(${user.id})">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('userEditModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('userEditModal'));
        modal.show();
    }
    
    function saveUserEdit(userId) {
        const formData = {
            username: document.getElementById('editUsername').value,
            email: document.getElementById('editEmail').value,
            first_name: document.getElementById('editFirstName').value,
            last_name: document.getElementById('editLastName').value,
            role: document.getElementById('editRole').value,
            is_active: document.getElementById('editIsActive').checked
        };
        
        fetch(`/admin-api/users/${userId}/edit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('userEditModal'));
                modal.hide();
                // Refresh the page to show updated data
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error || 'Failed to update user', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to update user', 'error');
        });
    }
    
    function toggleUserStatus(userId, userName, isActive) {
        const action = isActive ? 'deactivate' : 'activate';
        if (confirm(`Are you sure you want to ${action} user "${userName}"?`)) {
            // AJAX call to toggle user status
            fetch(`/admin-api/users/${userId}/toggle-status/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({is_active: !isActive})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`User "${userName}" ${action}d successfully!`, 'success');
                    location.reload(); // Refresh to show updated status
                } else {
                    showNotification(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showNotification('Error updating user status', 'error');
            });
        }
    }
    
    function deleteUser(userId, userName) {
        if (confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone!`)) {
            // AJAX call to delete user
            fetch(`/admin-api/users/${userId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`User "${userName}" deleted successfully!`, 'success');
                    location.reload(); // Refresh to remove deleted user
                } else {
                    showNotification(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showNotification('Error deleting user', 'error');
            });
        }
    }
    
    // Order Management Functions
    function showOrderEditModal(orderId) {
        // Fetch order data and show edit modal
        fetch(`/admin-api/orders/${orderId}/edit/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showOrderEditForm(data.order);
            } else {
                showNotification(data.error || 'Failed to load order data', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to load order data', 'error');
        });
    }
    
    function showOrderEditForm(order) {
        const modalHtml = `
            <div class="modal fade" id="orderEditModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <ion-icon name="create-outline" class="me-2"></ion-icon>
                                Edit Order: #${order.id}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="orderEditForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Order ID</label>
                                        <input type="text" class="form-control" value="${order.id}" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Customer</label>
                                        <input type="text" class="form-control" value="${order.user_name || 'N/A'}" readonly>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Restaurant</label>
                                        <input type="text" class="form-control" value="${order.restaurant_name || 'N/A'}" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Order Date</label>
                                        <input type="text" class="form-control" value="${new Date(order.created_at).toLocaleDateString()}" readonly>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Total Amount ($)</label>
                                        <input type="number" class="form-control" id="editOrderTotal" value="${order.total_amount}" step="0.01" min="0" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Status</label>
                                        <select class="form-select" id="editOrderStatus" required>
                                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <ion-icon name="information-circle-outline" class="me-2"></ion-icon>
                                    <small>You can edit the total amount and status of this order. Other details are read-only.</small>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveOrderEdit(${order.id})">
                                <ion-icon name="save-outline" class="me-1"></ion-icon>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('orderEditModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('orderEditModal'));
        modal.show();
    }
    
    function saveOrderEdit(orderId) {
        const formData = {
            total_amount: parseFloat(document.getElementById('editOrderTotal').value),
            status: document.getElementById('editOrderStatus').value
        };
        
        fetch(`/admin-api/orders/${orderId}/edit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message || 'Order updated successfully!', 'success');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('orderEditModal'));
                modal.hide();
                // Refresh the page to show updated data
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error || 'Failed to update order', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to update order', 'error');
        });
    }
    
    function showOrderStatusModal(orderId, currentStatus) {
        const statusOptions = [
            { value: 'pending', label: 'Pending', color: 'secondary' },
            { value: 'confirmed', label: 'Confirmed', color: 'warning' },
            { value: 'preparing', label: 'Preparing', color: 'info' },
            { value: 'ready', label: 'Ready', color: 'primary' },
            { value: 'delivered', label: 'Delivered', color: 'success' },
            { value: 'cancelled', label: 'Cancelled', color: 'danger' }
        ];
        
        const modalHtml = `
            <div class="modal fade" id="orderStatusModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <ion-icon name="refresh-outline" class="me-2"></ion-icon>
                                Update Order Status
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Order #${orderId}</label>
                                <p class="text-muted mb-3">Current Status: <span class="badge bg-${statusOptions.find(s => s.value === currentStatus)?.color || 'secondary'}">${statusOptions.find(s => s.value === currentStatus)?.label || currentStatus}</span></p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Select New Status</label>
                                <select class="form-select" id="orderStatusSelect" size="6">
                                    ${statusOptions.map(status => `
                                        <option value="${status.value}" ${status.value === currentStatus ? 'selected' : ''} 
                                                data-color="${status.color}">
                                            ${status.label}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="alert alert-info">
                                <ion-icon name="information-circle-outline" class="me-2"></ion-icon>
                                <small>Select the new status for this order and click "Update Status" to confirm.</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="updateOrderStatusFromModal(${orderId})">
                                <ion-icon name="checkmark-outline" class="me-1"></ion-icon>
                                Update Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('orderStatusModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('orderStatusModal'));
        modal.show();
        
        // Add visual feedback when selecting status
        const statusSelect = document.getElementById('orderStatusSelect');
        statusSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const color = selectedOption.getAttribute('data-color');
            this.className = `form-select border-${color}`;
        });
    }
    
    function updateOrderStatusFromModal(orderId) {
        const newStatus = document.getElementById('orderStatusSelect').value;
        const currentStatus = document.querySelector('#orderStatusModal .badge').textContent.trim();
        
        if (newStatus && newStatus !== currentStatus.toLowerCase()) {
            updateOrderStatus(orderId, newStatus);
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('orderStatusModal'));
            modal.hide();
        } else {
            showNotification('Please select a different status', 'warning');
        }
    }
    
    function updateOrderStatus(orderId, newStatus) {
        fetch(`/admin-api/orders/${orderId}/update-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({status: newStatus})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`Order #${orderId} status updated to ${newStatus}!`, 'success');
                const tbody = document.getElementById('ordersTableBody');
                if (tbody) {
                    loadOrderList();
                }
            } else {
                showNotification(`Error: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            showNotification('Error updating order status', 'error');
        });
    }
    
    function deleteOrder(orderId) {
        if (confirm(`Are you sure you want to delete Order #${orderId}? This action cannot be undone!`)) {
            fetch(`/admin-api/orders/${orderId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Order #${orderId} deleted successfully!`, 'success');
                    const tbody = document.getElementById('ordersTableBody');
                    if (tbody) {
                        loadOrderList();
                    }
                } else {
                    showNotification(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showNotification('Error deleting order', 'error');
            });
        }
    }
    
    // Dynamic Section Management
    function showAdminSection(sectionName) {
        console.log('ðŸ”„ Switching to section:', sectionName);
        
        // Clear all existing content first
        clearAllContent();
        
        // Create and show the new section
        createAdminSection(sectionName);
        
        // Update active navigation
        updateActiveNavigation(sectionName);
    }
    
    function clearAllContent() {
        console.log('ðŸ§¹ Clearing all content...');
        
        // Remove all existing admin sections
        const allSections = document.querySelectorAll('.admin-section');
        allSections.forEach(section => {
            console.log('ðŸ—‘ï¸ Removing section:', section.id);
            section.remove();
        });
        
        // Clear any modals that might be lingering
        const existingModals = document.querySelectorAll('.modal');
        existingModals.forEach(modal => {
            if (modal.id !== 'orderStatusModal') { // Keep the order status modal
                modal.remove();
            }
        });
        
        // Clear any global variables that might cause conflicts
        if (typeof allRestaurants !== 'undefined') {
            allRestaurants = [];
        }
        if (typeof allUsers !== 'undefined') {
            allUsers = [];
        }
    }
    
    function updateActiveNavigation(sectionName) {
        // Update active navigation
        const navLinks = document.querySelectorAll('.admin-nav-link');
        navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-section') === sectionName) {
                link.classList.add('active');
            }
        });
    }

    function createAdminSection(sectionName) {
        
        const mainContent = document.querySelector('.admin-content .container-fluid');
        if (!mainContent) {
            console.error('âŒ Main content container not found!');
            return;
        }
        
        let sectionContent = '';
        switch (sectionName) {
            case 'dashboard':
                // Restore the saved dashboard HTML if available
                sectionContent = window._comprehensiveDashboardContent || `
                    <div class="alert alert-info">Dashboard content not found.</div>
                `;
                break;
            case 'users':
                sectionContent = getUserManagementContent();
                break;
            case 'restaurants':
                sectionContent = getRestaurantManagementContent();
                break;
            case 'orders':
                sectionContent = getOrderManagementContent();
                break;
            case 'meals':
                sectionContent = getMealManagementContent();
                break;
            case 'analytics':
                sectionContent = getAnalyticsContent();
                break;
            case 'settings':
                sectionContent = getSettingsContent();
                break;
            default:
                sectionContent = '<div class="alert alert-info">Section coming soon!</div>';
        }
        
        // Create section element
        const section = document.createElement('div');
        section.id = `${sectionName}-section`;
        section.className = 'admin-section';
        section.innerHTML = sectionContent;
        section.style.display = 'block';
        
        // Replace all content in main container
        mainContent.innerHTML = '';
        mainContent.appendChild(section);
        
        console.log('âœ… Section created and displayed:', sectionName);
        
        // Add event listeners for specific sections after a short delay
        setTimeout(() => {
            addSectionEventListeners(sectionName);
        }, 100);
    }
    
    function addSectionEventListeners(sectionName) {
        console.log('ðŸ”— Adding event listeners for:', sectionName);
        
        switch(sectionName) {
            case 'users':
                addUserManagementEventListeners();
                break;
            case 'restaurants':
                addRestaurantManagementEventListeners();
                break;
            case 'orders':
                addOrderManagementEventListeners();
                break;
            case 'analytics':
                addAnalyticsEventListeners();
                break;
            case 'dashboard':
                addDashboardEventListeners();
                break;
        }
    }
    
    function getDashboardContent() {
        return `
            <div class="row mb-4">
                <div class="col-12">
                    <h2 class="fw-bold mb-0">Dashboard Overview</h2>
                    <p class="text-body-secondary mb-0">Welcome to the admin dashboard</p>
                </div>
            </div>
            <!-- Stats Cards will be loaded here -->
        `;
    }
    
    function getUserManagementContent() {
        return `
            <div id="users-section" class="admin-section">
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="fw-bold mb-0">User Management</h2>
                        <p class="text-body-secondary mb-0">Manage all platform users</p>
                    </div>
                </div>
            
            <!-- User Management Tools -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="settings-section">
                        <div class="row align-items-center mb-3">
                            <div class="col-md-6">
                                <h4 class="mb-0">
                                    <ion-icon name="people-outline" class="me-2"></ion-icon>
                                    All Users
                                    <span class="badge bg-primary ms-2">{{ users|length }}</span>
                                </h4>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-success" onclick="showAddUserModal()">
                                    <ion-icon name="add-outline" class="me-1"></ion-icon>
                                    Add New User
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportUsers()">
                                    <ion-icon name="download-outline" class="me-1"></ion-icon>
                                    Export Users
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-select filter-dropdown" id="userRoleFilter">
                                    <option value="">All Roles</option>
                                    <option value="customer">Customer</option>
                                    <option value="owner">Restaurant Owner</option>
                                    <option value="delivery">Delivery Person</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select filter-dropdown" id="userStatusFilter">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="userSearchInput" placeholder="Search users...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchUsers()">
                                        <ion-icon name="search"></ion-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Users Table -->
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllUsers" onchange="toggleSelectAll()">
                                        </th>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr data-user-id="{{ user.id }}" data-role="{{ user.role }}" data-status="{{ user.is_active|yesno:'active,inactive' }}">
                                        <td>
                                            <input type="checkbox" class="user-checkbox" value="{{ user.id }}">
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <ion-icon name="person-circle-outline" class="me-2" style="font-size: 1.5rem; color: var(--bs-primary);"></ion-icon>
                                                <div>
                                                    <h6 class="mb-0 fw-bold">{{ user.username }}</h6>
                                                    <small class="text-body-secondary">{{ user.get_full_name|default:"No name" }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ user.email }}</td>
                                        <td>
                                            <span class="badge bg-{% if user.role == 'admin' %}danger{% elif user.role == 'owner' %}warning{% elif user.role == 'delivery' %}info{% else %}success{% endif %}">
                                                {{ user.get_role_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="status-badge {% if user.is_active %}status-active{% else %}status-inactive{% endif %}">
                                                {% if user.is_active %}Active{% else %}Inactive{% endif %}
                                            </span>
                                        </td>
                                        <td>{{ user.date_joined|date:"M d, Y" }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary edit-user-btn" 
                                                        data-user-id="{{ user.id }}" 
                                                        data-user-name="{{ user.username }}"
                                                        title="Edit User">
                                                    <ion-icon name="create-outline"></ion-icon>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning toggle-user-status-btn" 
                                                        data-user-id="{{ user.id }}" 
                                                        data-user-name="{{ user.username }}"
                                                        data-is-active="{{ user.is_active|yesno:'true,false' }}"
                                                        title="Toggle Status">
                                                    <ion-icon name="{% if user.is_active %}eye-off-outline{% else %}eye-outline{% endif %}"></ion-icon>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger delete-user-btn" 
                                                        data-user-id="{{ user.id }}" 
                                                        data-user-name="{{ user.username }}"
                                                        title="Delete User">
                                                    <ion-icon name="trash-outline"></ion-icon>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Bulk Actions -->
                        <div class="row mt-3" id="bulkActions" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-info d-flex align-items-center justify-content-between">
                                    <span>
                                        <ion-icon name="information-circle-outline" class="me-2"></ion-icon>
                                        <span id="selectedCount">0</span> users selected
                                    </span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-warning me-2" onclick="bulkToggleStatus()">
                                            <ion-icon name="eye-outline" class="me-1"></ion-icon>
                                            Toggle Status
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="bulkDeleteUsers()">
                                            <ion-icon name="trash-outline" class="me-1"></ion-icon>
                                            Delete Selected
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        `;
    }
    
    function getRestaurantManagementContent() {
        return `
            <div id="restaurants-section" class="admin-section">
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="fw-bold mb-0">Restaurant Management</h2>
                        <p class="text-body-secondary mb-0">Manage restaurants and their settings</p>
                    </div>
                </div>
            <div class="row">
                <div class="col-12">
                    <div class="settings-section">
                        <h4 class="mb-4">
                            <ion-icon name="restaurant-outline" class="me-2"></ion-icon>
                            Restaurant Management Tools
                            <span class="badge bg-warning ms-2">{{ total_restaurants }}</span>
                        </h4>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="list-outline" class="me-2"></ion-icon>
                                            All Restaurants
                                        </h5>
                                        <p class="card-text">View and manage all registered restaurants.</p>
                                        <button class="btn btn-outline-primary" onclick="showRestaurantList()">
                                            <ion-icon name="list-outline" class="me-1"></ion-icon>
                                            View Restaurants
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="add-outline" class="me-2"></ion-icon>
                                            Add Restaurant
                                        </h5>
                                        <p class="card-text">Register a new restaurant to the platform.</p>
                                        <button class="btn btn-outline-success" onclick="showAddRestaurantModal()">
                                            <ion-icon name="add-outline" class="me-1"></ion-icon>
                                            Add Restaurant
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="analytics-outline" class="me-2"></ion-icon>
                                            Restaurant Analytics
                                        </h5>
                                        <p class="card-text">View restaurant performance and statistics.</p>
                                        <button class="btn btn-outline-info" onclick="showRestaurantAnalytics()">
                                            <ion-icon name="bar-chart-outline" class="me-1"></ion-icon>
                                            View Analytics
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <ion-icon name="information-circle-outline" class="me-2"></ion-icon>
                                    <strong>Restaurant Management Features:</strong> 
                                    Manage restaurant registrations, edit restaurant details, 
                                    toggle restaurant status, and view restaurant performance metrics.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        `;
    }
    
    function getOrderManagementContent() {
        return `
            <div id="orders-section" class="admin-section">
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="fw-bold mb-0">Order Management</h2>
                        <p class="text-body-secondary mb-0">Manage all orders and their status</p>
                    </div>
                </div>
            <div class="row">
                <div class="col-12">
                    <div class="settings-section">
                        <h4 class="mb-4">
                            <ion-icon name="receipt-outline" class="me-2"></ion-icon>
                            Order Management Tools
                            <span class="badge bg-primary ms-2">{{ recent_orders|length }}</span>
                        </h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="list-outline" class="me-2"></ion-icon>
                                            Order List
                                        </h5>
                                        <p class="card-text">View and manage all orders with advanced filtering and search.</p>
                                        <button class="btn btn-outline-primary" onclick="showOrderList()">
                                            <ion-icon name="list-outline" class="me-1"></ion-icon>
                                            View Orders
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="analytics-outline" class="me-2"></ion-icon>
                                            Order Analytics
                                        </h5>
                                        <p class="card-text">View order statistics, revenue reports, and performance metrics.</p>
                                        <button class="btn btn-outline-primary" onclick="showOrderAnalytics()">
                                            <ion-icon name="bar-chart-outline" class="me-1"></ion-icon>
                                            View Analytics
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <ion-icon name="information-circle-outline" class="me-2"></ion-icon>
                                    <strong>Order Management Features:</strong> 
                                    View orders, update status, edit details, and manage order lifecycle. 
                                    All order operations are available through the action buttons in the orders table.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        `;
    }
    
    function getMealManagementContent() {
        return `
            <div id="meals-section" class="admin-section">
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="fw-bold mb-0">Meal Management</h2>
                        <p class="text-body-secondary mb-0">Manage meals across all restaurants</p>
                    </div>
                </div>
            <div class="row">
                <div class="col-12">
                    <div class="settings-section">
                        <h4 class="mb-4">
                            <ion-icon name="fast-food-outline" class="me-2"></ion-icon>
                            Meal Management Tools
                            <span class="badge bg-secondary ms-2">0</span>
                        </h4>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="list-outline" class="me-2"></ion-icon>
                                            All Meals
                                        </h5>
                                        <p class="card-text">View and manage all meals from all restaurants.</p>
                                        <button class="btn btn-outline-primary" onclick="showMealList()">
                                            <ion-icon name="list-outline" class="me-1"></ion-icon>
                                            View Meals
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="add-outline" class="me-2"></ion-icon>
                                            Add Meal
                                        </h5>
                                        <p class="card-text">Add a new meal to any restaurant.</p>
                                        <button class="btn btn-outline-success" onclick="showAddMealModal()">
                                            <ion-icon name="add-outline" class="me-1"></ion-icon>
                                            Add Meal
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="restaurant-outline" class="me-2"></ion-icon>
                                            By Restaurant
                                        </h5>
                                        <p class="card-text">Manage meals by specific restaurant.</p>
                                        <button class="btn btn-outline-info" onclick="showMealsByRestaurant()">
                                            <ion-icon name="restaurant-outline" class="me-1"></ion-icon>
                                            By Restaurant
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="analytics-outline" class="me-2"></ion-icon>
                                            Meal Analytics
                                        </h5>
                                        <p class="card-text">View meal performance and popularity.</p>
                                        <button class="btn btn-outline-warning" onclick="showMealAnalytics()">
                                            <ion-icon name="bar-chart-outline" class="me-1"></ion-icon>
                                            Analytics
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <ion-icon name="information-circle-outline" class="me-2"></ion-icon>
                                    <strong>Meal Management Features:</strong> 
                                    Manage meals across all restaurants, edit meal details, 
                                    toggle availability, and view meal performance metrics.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        `;
    }
    
    function getAnalyticsContent() {
        return `
            <div class="row mb-4">
                <div class="col-12">
                    <h2 class="fw-bold mb-0">Analytics Dashboard</h2>
                    <p class="text-body-secondary mb-0">Comprehensive platform analytics and insights</p>
                </div>
            </div>
            
            <!-- Analytics Navigation -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-outline-primary w-100" onclick="showOrderAnalytics()">
                                        <ion-icon name="receipt-outline" class="me-2"></ion-icon>
                                        Order Analytics
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-outline-success w-100" onclick="showRestaurantAnalytics()">
                                        <ion-icon name="restaurant-outline" class="me-2"></ion-icon>
                                        Restaurant Analytics
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-outline-info w-100" onclick="showUserAnalytics()">
                                        <ion-icon name="people-outline" class="me-2"></ion-icon>
                                        User Analytics
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-outline-warning w-100" onclick="showPlatformAnalytics()">
                                        <ion-icon name="trending-up-outline" class="me-2"></ion-icon>
                                        Platform Analytics
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Overview Stats -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center" style="width: 3rem; height: 3rem;">
                                        <ion-icon name="people-outline" class="text-white" style="font-size: 1.5rem;"></ion-icon>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-body-secondary small fw-medium">Total Users</div>
                                    <div class="h4 mb-0 fw-bold" id="analyticsTotalUsers">{{ total_users }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-success bg-gradient rounded-circle d-flex align-items-center justify-content-center" style="width: 3rem; height: 3rem;">
                                        <ion-icon name="restaurant-outline" class="text-white" style="font-size: 1.5rem;"></ion-icon>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-body-secondary small fw-medium">Restaurants</div>
                                    <div class="h4 mb-0 fw-bold" id="analyticsTotalRestaurants">{{ total_restaurants }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-warning bg-gradient rounded-circle d-flex align-items-center justify-content-center" style="width: 3rem; height: 3rem;">
                                        <ion-icon name="receipt-outline" class="text-white" style="font-size: 1.5rem;"></ion-icon>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-body-secondary small fw-medium">Total Orders</div>
                                    <div class="h4 mb-0 fw-bold" id="analyticsTotalOrders">{{ total_orders }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-info bg-gradient rounded-circle d-flex align-items-center justify-content-center" style="width: 3rem; height: 3rem;">
                                        <ion-icon name="cash-outline" class="text-white" style="font-size: 1.5rem;"></ion-icon>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-body-secondary small fw-medium">Total Revenue</div>
                                    <div class="h4 mb-0 fw-bold" id="analyticsTotalRevenue">$0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="fw-bold mb-0">
                                <ion-icon name="bar-chart-outline" class="me-2"></ion-icon>
                                Platform Growth Over Time
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="platformGrowthChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="fw-bold mb-0">
                                <ion-icon name="pie-chart-outline" class="me-2"></ion-icon>
                                User Distribution
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="platformUserDistributionChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="fw-bold mb-0">
                                <ion-icon name="time-outline" class="me-2"></ion-icon>
                                Recent Orders
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analyticsRecentOrders">
                                        <tr>
                                            <td colspan="4" class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted small">Loading recent orders...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="fw-bold mb-0">
                                <ion-icon name="restaurant-outline" class="me-2"></ion-icon>
                                Top Restaurants
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Restaurant</th>
                                            <th>Orders</th>
                                            <th>Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analyticsTopRestaurants">
                                        <tr>
                                            <td colspan="3" class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted small">Loading top restaurants...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function getSettingsContent() {
        return `
            <div class="row mb-4">
                <div class="col-12">
                    <h2 class="fw-bold mb-0">Platform Settings</h2>
                    <p class="text-body-secondary mb-0">Configure platform-wide settings</p>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="settings-section">
                        <h4 class="mb-4">
                            <ion-icon name="cog-outline" class="me-2"></ion-icon>
                            Quick Settings
                        </h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="information-circle-outline" class="me-2"></ion-icon>
                                            Site Information
                                        </h5>
                                        <p class="card-text">Configure site name, description, logo, and basic information.</p>
                                        <a href="/admin-api/settings/#site-info" class="btn btn-outline-primary">
                                            <ion-icon name="settings-outline" class="me-1"></ion-icon>
                                            Manage Site Info
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="call-outline" class="me-2"></ion-icon>
                                            Contact & Support
                                        </h5>
                                        <p class="card-text">Set up contact information and support details.</p>
                                        <a href="/admin-api/settings/#contact-support" class="btn btn-outline-primary">
                                            <ion-icon name="settings-outline" class="me-1"></ion-icon>
                                            Manage Contact
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="cash-outline" class="me-2"></ion-icon>
                                            Pricing & Fees
                                        </h5>
                                        <p class="card-text">Configure delivery fees, tax rates, and pricing settings.</p>
                                        <a href="/admin-api/settings/#pricing-fees" class="btn btn-outline-primary">
                                            <ion-icon name="settings-outline" class="me-1"></ion-icon>
                                            Manage Pricing
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <ion-icon name="toggle-outline" class="me-2"></ion-icon>
                                            Feature Toggles
                                        </h5>
                                        <p class="card-text">Enable/disable platform features and maintenance mode.</p>
                                        <a href="/admin-api/settings/#feature-toggles" class="btn btn-outline-primary">
                                            <ion-icon name="settings-outline" class="me-1"></ion-icon>
                                            Manage Features
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <ion-icon name="information-circle-outline" class="me-2"></ion-icon>
                                    <strong>Full Settings Panel:</strong> 
                                    <a href="/admin-api/settings/" class="alert-link">Click here to access the complete platform settings panel</a> 
                                    with all configuration options including SEO, social media, and advanced settings.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // User Management Event Listeners
    function addUserManagementEventListeners() {
        // Edit User buttons
        const editUserBtns = document.querySelectorAll('.edit-user-btn');
        editUserBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const userName = this.getAttribute('data-user-name');
                showUserEditModal(userId, userName);
            });
        });
        
        // Toggle User Status buttons
        const toggleUserStatusBtns = document.querySelectorAll('.toggle-user-status-btn');
        toggleUserStatusBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const userName = this.getAttribute('data-user-name');
                const isActive = this.getAttribute('data-is-active') === 'true';
                toggleUserStatus(userId, userName, isActive);
            });
        });
        
        // Delete User buttons
        const deleteUserBtns = document.querySelectorAll('.delete-user-btn');
        deleteUserBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const userName = this.getAttribute('data-user-name');
                deleteUser(userId, userName);
            });
        });
        
        // Search and filter functionality
        const userSearchInput = document.getElementById('userSearchInput');
        if (userSearchInput) {
            userSearchInput.addEventListener('input', searchUsers);
        }
        
        const userRoleFilter = document.getElementById('userRoleFilter');
        if (userRoleFilter) {
            userRoleFilter.addEventListener('change', filterUsers);
        }
        
        const userStatusFilter = document.getElementById('userStatusFilter');
        if (userStatusFilter) {
            userStatusFilter.addEventListener('change', filterUsers);
        }
        
        // Select all checkbox
        const selectAllUsers = document.getElementById('selectAllUsers');
        if (selectAllUsers) {
            selectAllUsers.addEventListener('change', toggleSelectAll);
        }
        
        console.log('âœ… User management event listeners added');
    }
    
    function addRestaurantManagementEventListeners() {
        console.log('ðŸ”— Adding restaurant management event listeners...');
        
        // Add event listeners for restaurant management
        const searchInput = document.getElementById('restaurantSearch');
        const statusFilter = document.getElementById('restaurantStatusFilter');
        const sortSelect = document.getElementById('restaurantSortBy');
        
        if (searchInput) {
            searchInput.addEventListener('input', filterRestaurants);
        }
        
        if (statusFilter) {
            statusFilter.addEventListener('change', filterRestaurants);
        }
        
        if (sortSelect) {
            sortSelect.addEventListener('change', filterRestaurants);
        }
        
        // Load restaurant data after event listeners are attached
        console.log('ðŸ“Š Loading restaurant data...');
        loadRestaurantList();
        
        console.log('âœ… Restaurant management event listeners added');
    }
    
    function addOrderManagementEventListeners() {
        console.log('ðŸ”— Adding order management event listeners...');
        
        // Delegate clicks from the table body to avoid timing issues
        const tbody = document.getElementById('ordersTableBody');
        if (tbody && !tbody.dataset.listenersAttached) {
            tbody.addEventListener('click', function(event) {
                const editBtn = event.target.closest('.edit-order-btn');
                const statusBtn = event.target.closest('.update-order-status-btn');
                const deleteBtn = event.target.closest('.delete-order-btn');
                
                if (editBtn) {
                    const orderId = editBtn.getAttribute('data-order-id');
                    showOrderEditModal(orderId);
                    return;
                }
                
                if (statusBtn) {
                    const orderId = statusBtn.getAttribute('data-order-id');
                    const tr = statusBtn.closest('tr');
                    const currentStatus = tr ? tr.getAttribute('data-order-status') : statusBtn.getAttribute('data-current-status');
                    showOrderStatusModal(orderId, currentStatus);
                    return;
                }
                
                if (deleteBtn) {
                    const orderId = deleteBtn.getAttribute('data-order-id');
                    deleteOrder(orderId);
                    return;
                }
            });
            tbody.dataset.listenersAttached = 'true';
        }
        
        // Add filter event listeners
        const searchInput = document.getElementById('orderSearch');
        const statusFilter = document.getElementById('orderStatusFilter');
        const sortSelect = document.getElementById('orderSortBy');
        const dateFilter = document.getElementById('orderDateFilter');
        const selectAllCheckbox = document.getElementById('selectAllOrders');
        
        if (searchInput) {
            searchInput.addEventListener('input', filterOrders);
        }
        
        if (statusFilter) {
            statusFilter.addEventListener('change', filterOrders);
        }
        
        if (sortSelect) {
            sortSelect.addEventListener('change', filterOrders);
        }
        
        if (dateFilter) {
            dateFilter.addEventListener('change', filterOrders);
        }
        
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', toggleSelectAllOrders);
        }
        
        // Add checkbox change listeners for bulk actions
        const orderCheckboxes = document.querySelectorAll('.order-checkbox');
        orderCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateOrderBulkActions);
        });
        
        console.log('âœ… Order management event listeners added');
    }
    
    function addDashboardEventListeners() {
        console.log('ðŸ”— Adding dashboard event listeners...');
        
        // Add event listeners for dashboard quick actions
        const quickActionButtons = document.querySelectorAll('.quick-action-btn');
        const dashboardSearchInput = document.getElementById('dashboardUserSearch');
        const dashboardRoleFilter = document.getElementById('dashboardRoleFilter');
        const dashboardStatusFilter = document.getElementById('dashboardStatusFilter');
        
        quickActionButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                if (section) {
                    showAdminSection(section);
                }
            });
        });
        
        if (dashboardSearchInput) {
            dashboardSearchInput.addEventListener('input', searchDashboardUsers);
        }
        
        if (dashboardRoleFilter) {
            dashboardRoleFilter.addEventListener('change', filterDashboardUsers);
        }
        
        if (dashboardStatusFilter) {
            dashboardStatusFilter.addEventListener('change', filterDashboardUsers);
        }
        
        console.log('âœ… Dashboard event listeners added');
    }
    
    function addAnalyticsEventListeners() {
        console.log('ðŸ”— Adding analytics event listeners...');
        
        // Load analytics data when the section is created
        loadAnalyticsData();
        
        console.log('âœ… Analytics event listeners added');
    }

    // Platform Settings Functions
    function loadPlatformSettings() {
        fetch('/admin-api/settings/get/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                
                // Populate form fields
                document.getElementById('siteName').value = settings.site_name || '';
                document.getElementById('siteDescription').value = settings.site_description || '';
                document.getElementById('contactEmail').value = settings.contact_email || '';
                document.getElementById('supportPhone').value = settings.support_phone || '';
                document.getElementById('supportEmail').value = settings.support_email || '';
                document.getElementById('defaultDeliveryFee').value = settings.default_delivery_fee || '';
                document.getElementById('freeDeliveryThreshold').value = settings.free_delivery_threshold || '';
                
                showNotification('Platform settings loaded successfully!', 'success');
            } else {
                showNotification('Error loading settings: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to load platform settings', 'error');
        });
    }
    
    function savePlatformSettings() {
        const formData = {
            site_name: document.getElementById('siteName').value,
            site_description: document.getElementById('siteDescription').value,
            contact_email: document.getElementById('contactEmail').value,
            support_phone: document.getElementById('supportPhone').value,
            support_email: document.getElementById('supportEmail').value,
            default_delivery_fee: parseFloat(document.getElementById('defaultDeliveryFee').value) || 0,
            free_delivery_threshold: parseFloat(document.getElementById('freeDeliveryThreshold').value) || 0
        };
        
        fetch('/admin-api/settings/update/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Platform settings saved successfully!', 'success');
                // Reload the page to reflect changes
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error saving settings: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to save platform settings', 'error');
        });
    }

    // Enhanced User Management Functions
    function showAddUserModal() {
        const modalHtml = `
            <div class="modal fade" id="addUserModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <ion-icon name="person-add-outline" class="me-2"></ion-icon>
                                Add New User
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addUserForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Username *</label>
                                        <input type="text" class="form-control" id="addUsername" name="username" placeholder="Enter username" required>
                                        <div class="form-text">Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Email Address *</label>
                                        <input type="email" class="form-control" id="addEmail" name="email" placeholder="Enter email address" required>
                                        <div class="form-text">Required. Enter a valid email address.</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">First Name</label>
                                        <input type="text" class="form-control" id="addFirstName" name="first_name" placeholder="Enter first name">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Last Name</label>
                                        <input type="text" class="form-control" id="addLastName" name="last_name" placeholder="Enter last name">
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Password *</label>
                                        <input type="password" class="form-control" id="addPassword1" name="password1" placeholder="Create password" required>
                                        <div class="form-text">Your password must contain at least 8 characters.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Confirm Password *</label>
                                        <input type="password" class="form-control" id="addPassword2" name="password2" placeholder="Confirm password" required>
                                        <div class="form-text">Enter the same password as before, for verification.</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">User Role *</label>
                                        <select class="form-select" id="addUserRole" name="role" required>
                                            <option value="">Select a role</option>
                                            <option value="customer">Customer</option>
                                            <option value="owner">Restaurant Owner</option>
                                            <option value="delivery">Delivery Person</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                        <div class="form-text">Select the user's role on the platform.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Account Status</label>
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="addUserActive" name="is_active" checked>
                                            <label class="form-check-label" for="addUserActive">
                                                Active Account
                                            </label>
                                        </div>
                                        <div class="form-text">Uncheck to create an inactive account.</div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <ion-icon name="information-circle-outline" class="me-2"></ion-icon>
                                    <strong>Note:</strong> The user will be able to log in immediately with the provided credentials. 
                                    Make sure to share the login details with the user securely.
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveNewUser()">
                                <ion-icon name="save-outline" class="me-1"></ion-icon>
                                Create User
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('addUserModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
        modal.show();
    }
    
    function saveNewUser() {
        // Get form data
        const formData = {
            username: document.getElementById('addUsername').value,
            email: document.getElementById('addEmail').value,
            first_name: document.getElementById('addFirstName').value,
            last_name: document.getElementById('addLastName').value,
            password1: document.getElementById('addPassword1').value,
            password2: document.getElementById('addPassword2').value,
            role: document.getElementById('addUserRole').value,
            is_active: document.getElementById('addUserActive').checked
        };
        
        // Basic validation
        if (!formData.username || !formData.email || !formData.password1 || !formData.password2 || !formData.role) {
            showNotification('Please fill in all required fields', 'warning');
            return;
        }
        
        if (formData.password1 !== formData.password2) {
            showNotification('Passwords do not match', 'error');
            return;
        }
        
        if (formData.password1.length < 8) {
            showNotification('Password must be at least 8 characters long', 'error');
            return;
        }
        
        // Send request to create user
        fetch('/admin-api/users/create/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('User created successfully!', 'success');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                modal.hide();
                // Refresh the page to show the new user
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error creating user: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to create user', 'error');
        });
    }
    
    function exportUsers() {
        showNotification('Export Users functionality coming soon!', 'info');
    }
    
    function searchUsers() {
        const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#usersTable tbody tr');
        
        rows.forEach(row => {
            const username = row.querySelector('h6').textContent.toLowerCase();
            const email = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            const fullName = row.querySelector('small').textContent.toLowerCase();
            
            if (username.includes(searchTerm) || email.includes(searchTerm) || fullName.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAllUsers');
        const checkboxes = document.querySelectorAll('.user-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateBulkActions();
    }
    
    function updateBulkActions() {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        const bulkActions = document.getElementById('bulkActions');
        const selectedCount = document.getElementById('selectedCount');
        
        if (checkboxes.length > 0) {
            bulkActions.style.display = 'block';
            selectedCount.textContent = checkboxes.length;
        } else {
            bulkActions.style.display = 'none';
        }
    }
    
    function bulkToggleStatus() {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        if (checkboxes.length === 0) {
            showNotification('Please select users first', 'warning');
            return;
        }
        
        const userIds = Array.from(checkboxes).map(cb => cb.value);
        const action = confirm(`Toggle status for ${userIds.length} selected users?`);
        
        if (action) {
            showNotification(`Bulk toggle status for ${userIds.length} users - Coming soon!`, 'info');
        }
    }
    
    function bulkDeleteUsers() {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        if (checkboxes.length === 0) {
            showNotification('Please select users first', 'warning');
            return;
        }
        
        const userIds = Array.from(checkboxes).map(cb => cb.value);
        const action = confirm(`Delete ${userIds.length} selected users? This action cannot be undone!`);
        
        if (action) {
            showNotification(`Bulk delete for ${userIds.length} users - Coming soon!`, 'info');
        }
    }
    
    // Add event listeners for checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('user-checkbox')) {
            updateBulkActions();
        }
    });
    
    // Add event listener for search input
    document.addEventListener('input', function(e) {
        if (e.target.id === 'userSearchInput') {
            searchUsers();
        }
    });
    
    // Add event listeners for filter dropdowns
    document.addEventListener('change', function(e) {
        if (e.target.id === 'userRoleFilter' || e.target.id === 'userStatusFilter') {
            filterUsers();
        }
        if (e.target.id === 'dashboardRoleFilter' || e.target.id === 'dashboardStatusFilter') {
            filterDashboardUsers();
        }
    });
    
    // Add event listener for dashboard search input
    document.addEventListener('input', function(e) {
        if (e.target.id === 'dashboardUserSearch') {
            searchDashboardUsers();
        }
    });
    
    function filterUsers() {
        const roleFilter = document.getElementById('userRoleFilter').value;
        const statusFilter = document.getElementById('userStatusFilter').value;
        const rows = document.querySelectorAll('#usersTable tbody tr');
        
        rows.forEach(row => {
            const userRole = row.getAttribute('data-role');
            const userStatus = row.getAttribute('data-status');
            
            let showRow = true;
            
            if (roleFilter && userRole !== roleFilter) {
                showRow = false;
            }
            
            if (statusFilter && userStatus !== statusFilter) {
                showRow = false;
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    }
    
    // Dashboard User Management Filter Functions
    function searchDashboardUsers() {
        const searchTerm = document.getElementById('dashboardUserSearch').value.toLowerCase();
        const rows = document.querySelectorAll('.settings-section .user-table tbody tr');
        
        rows.forEach(row => {
            const username = row.querySelector('h6').textContent.toLowerCase();
            const email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const fullName = row.querySelector('small').textContent.toLowerCase();
            
            if (username.includes(searchTerm) || email.includes(searchTerm) || fullName.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function filterDashboardUsers() {
        const roleFilter = document.getElementById('dashboardRoleFilter').value;
        const statusFilter = document.getElementById('dashboardStatusFilter').value;
        const rows = document.querySelectorAll('.settings-section .user-table tbody tr');
        
        rows.forEach(row => {
            const userRole = row.getAttribute('data-role');
            const userStatus = row.getAttribute('data-status');
            
            let showRow = true;
            
            if (roleFilter && userRole !== roleFilter) {
                showRow = false;
            }
            
            if (statusFilter && userStatus !== statusFilter) {
                showRow = false;
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    }
    
    // Order Management Functions
    function showOrderList() {
        console.log('ðŸ”„ Showing order list...');
        
        // Clear all content first
        clearAllContent();
        
        // Create order list content
        const content = `
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="fw-bold mb-0">All Orders</h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshOrderList()">
                                <ion-icon name="refresh-outline" class="me-1"></ion-icon>
                                Refresh
                            </button>
                            <button class="btn btn-success" onclick="showAddOrderModal()">
                                <ion-icon name="add-outline" class="me-1"></ion-icon>
                                Add Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">
                            <ion-icon name="search-outline"></ion-icon>
                        </span>
                        <input type="text" class="form-control" id="orderSearch" placeholder="Search orders...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="orderStatusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="preparing">Preparing</option>
                        <option value="ready">Ready</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="orderSortBy">
                        <option value="id">Sort by ID</option>
                        <option value="created_at">Sort by Date</option>
                        <option value="total_amount">Sort by Amount</option>
                        <option value="status">Sort by Status</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="orderDateFilter">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="ordersTable">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAllOrders()">
                                            </th>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Restaurant</th>
                                            <th>Items</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersTableBody">
                                        <tr>
                                            <td colspan="9" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Loading orders...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3" id="orderBulkActions" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3">
                                <span class="text-muted">Bulk Actions:</span>
                                <button class="btn btn-outline-warning btn-sm" onclick="bulkUpdateOrderStatus()">
                                    <ion-icon name="refresh-outline" class="me-1"></ion-icon>
                                    Update Status
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteOrders()">
                                    <ion-icon name="trash-outline" class="me-1"></ion-icon>
                                    Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Create and display the content directly
        const mainContent = document.querySelector('.admin-content .container-fluid');
        if (mainContent) {
            mainContent.innerHTML = content;
            
            // Load order data after content is created
            setTimeout(() => {
                loadOrderList();
                addOrderManagementEventListeners();
            }, 100);
        } else {
            console.error('âŒ Main content container not found!');
        }
    }
    
    function showOrderAnalytics() {
        console.log('ðŸ”„ Showing order analytics...');
        
        // Clear all content first
        clearAllContent();
        
        // Create order analytics content
        const content = `
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="fw-bold mb-0">Order Analytics</h3>
                    <p class="text-body-secondary mb-0">Performance metrics and insights for all orders</p>
                </div>
            </div>
            
            <!-- Analytics Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center" style="width: 3rem; height: 3rem;">
                                        <ion-icon name="receipt-outline" class="text-white" style="font-size: 1.5rem;"></ion-icon>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-body-secondary small fw-medium">Total Orders</div>
                                    <div class="h4 mb-0 fw-bold" id="totalOrdersCount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-success bg-gradient rounded-circle d-flex align-items-center justify-content-center" style="width: 3rem; height: 3rem;">
                                        <ion-icon name="cash-outline" class="text-white" style="font-size: 1.5rem;"></ion-icon>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-body-secondary small fw-medium">Total Revenue</div>
                                    <div class="h4 mb-0 fw-bold" id="totalRevenue">$0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-warning bg-gradient rounded-circle d-flex align-items-center justify-content-center" style="width: 3rem; height: 3rem;">
                                        <ion-icon name="time-outline" class="text-white" style="font-size: 1.5rem;"></ion-icon>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-body-secondary small fw-medium">Avg Order Value</div>
                                    <div class="h4 mb-0 fw-bold" id="avgOrderValue">$0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-info bg-gradient rounded-circle d-flex align-items-center justify-content-center" style="width: 3rem; height: 3rem;">
                                        <ion-icon name="checkmark-circle-outline" class="text-white" style="font-size: 1.5rem;"></ion-icon>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-body-secondary small fw-medium">Completion Rate</div>
                                    <div class="h4 mb-0 fw-bold" id="completionRate">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="fw-bold mb-0">
                                <ion-icon name="bar-chart-outline" class="me-2"></ion-icon>
                                Orders Over Time
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="ordersOverTimeChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="fw-bold mb-0">
                                <ion-icon name="pie-chart-outline" class="me-2"></ion-icon>
                                Order Status Distribution
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="orderStatusChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Revenue Analysis -->
            <div class="row mb-4">
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="fw-bold mb-0">
                                <ion-icon name="trending-up-outline" class="me-2"></ion-icon>
                                Revenue Trends
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="revenueChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="fw-bold mb-0">
                                <ion-icon name="restaurant-outline" class="me-2"></ion-icon>
                                Top Performing Restaurants
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Restaurant</th>
                                            <th>Orders</th>
                                            <th>Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topRestaurantsTable">
                                        <tr>
                                            <td colspan="3" class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted small">Loading data...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Orders Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="fw-bold mb-0">
                                <ion-icon name="list-outline" class="me-2"></ion-icon>
                                Recent Orders
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Restaurant</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentOrdersTable">
                                        <tr>
                                            <td colspan="6" class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted small">Loading recent orders...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Create and display the content directly
        const mainContent = document.querySelector('.admin-content .container-fluid');
        if (mainContent) {
            mainContent.innerHTML = content;
            
            // Load analytics data after content is created
            setTimeout(() => {
                loadOrderAnalytics();
            }, 100);
        } else {
            console.error('âŒ Main content container not found!');
        }
    }
    
    function showAddOrderModal() {
        showNotification('Add Order functionality coming soon!', 'info');
    }
    
    // Supporting functions for order management
    function loadOrderList() {
        console.log('ðŸ”„ Loading order list...');
        
        // Check if the table body exists
        const tbody = document.getElementById('ordersTableBody');
        if (!tbody) {
            console.error('âŒ Order table body not found!');
            showNotification('Order table not ready. Please try again.', 'error');
            return;
        }
        
        fetch('/admin-api/orders/list/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('ðŸ“Š Order data received:', data);
            if (data.success) {
                allOrders = data.orders; // Store globally for filtering
                displayOrderList(data.orders);
                console.log('âœ… Order list displayed successfully');
            } else {
                console.error('âŒ Error from server:', data.error);
                showNotification('Error loading orders: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('âŒ Network error:', error);
            showNotification('Error loading orders: ' + error.message, 'error');
        });
    }
    
    function displayOrderList(orders) {
        const tbody = document.getElementById('ordersTableBody');
        if (orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <ion-icon name="receipt-outline" style="font-size: 3rem; color: #ccc;"></ion-icon>
                        <p class="mt-2 text-muted">No orders found</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => `
            <tr data-order-id="${order.id}" data-order-status="${order.status}">
                <td>
                    <input type="checkbox" class="order-checkbox" value="${order.id}">
                </td>
                <td><span class="fw-bold">#${order.id}</span></td>
                <td>
                    <div class="d-flex align-items-center">
                        <ion-icon name="person-circle-outline" class="me-2" style="font-size: 1.5rem; color: var(--bs-primary);"></ion-icon>
                        <div>
                            <div class="fw-medium">${order.user.username}</div>
                            <small class="text-muted">${order.user.email}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="fw-medium">${order.restaurant.name}</div>
                    <small class="text-muted">${order.restaurant.location}</small>
                </td>
                <td>
                    <span class="badge bg-info">${order.items_count || 0} items</span>
                </td>
                <td><span class="fw-bold">$${parseFloat(order.total_amount).toFixed(2)}</span></td>
                <td>
                    <span class="badge bg-${getOrderStatusColor(order.status)}">
                        ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                    </span>
                </td>
                <td>
                    <div class="small">${new Date(order.created_at).toLocaleDateString()}</div>
                    <div class="text-muted small">${new Date(order.created_at).toLocaleTimeString()}</div>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary edit-order-btn" data-order-id="${order.id}" title="Edit Order">
                            <ion-icon name="create-outline"></ion-icon>
                        </button>
                        <button class="btn btn-sm btn-outline-warning update-order-status-btn" data-order-id="${order.id}" title="Update Status">
                            <ion-icon name="refresh-outline"></ion-icon>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-order-btn" data-order-id="${order.id}" title="Delete Order">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    function loadOrderAnalytics() {
        console.log('ðŸ”„ Loading order analytics...');
        
        fetch('/admin-api/orders/analytics/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('ðŸ“Š Order analytics data received:', data);
            if (data.success) {
                displayOrderAnalytics(data.analytics);
                console.log('âœ… Order analytics displayed successfully');
            } else {
                console.error('âŒ Error from server:', data.error);
                showNotification('Error loading analytics: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('âŒ Network error:', error);
            showNotification('Error loading analytics: ' + error.message, 'error');
        });
    }
    
    function displayOrderAnalytics(analytics) {
        // Update analytics cards
        document.getElementById('totalOrdersCount').textContent = analytics.total_orders || 0;
        document.getElementById('totalRevenue').textContent = '$' + (analytics.total_revenue || 0).toFixed(2);
        const aovOrders = parseFloat(analytics.avg_order_value);
        document.getElementById('avgOrderValue').textContent = '$' + (isNaN(aovOrders) ? 0 : aovOrders).toFixed(2);
        document.getElementById('completionRate').textContent = (analytics.completion_rate || 0) + '%';
        
        // Update top restaurants table
        const topRestaurantsTable = document.getElementById('topRestaurantsTable');
        if (analytics.top_restaurants && analytics.top_restaurants.length > 0) {
            topRestaurantsTable.innerHTML = analytics.top_restaurants.map(restaurant => `
                <tr>
                    <td>
                        <div class="fw-medium">${restaurant.name}</div>
                        <small class="text-muted">${restaurant.location}</small>
                    </td>
                    <td><span class="badge bg-primary">${restaurant.orders_count}</span></td>
                    <td><span class="fw-bold">$${parseFloat(restaurant.revenue).toFixed(2)}</span></td>
                </tr>
            `).join('');
        } else {
            topRestaurantsTable.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center py-3">
                        <ion-icon name="restaurant-outline" style="font-size: 2rem; color: #ccc;"></ion-icon>
                        <p class="mt-2 text-muted small">No restaurant data available</p>
                    </td>
                </tr>
            `;
        }
        
        // Update recent orders table
        const recentOrdersTable = document.getElementById('recentOrdersTable');
        if (analytics.recent_orders && analytics.recent_orders.length > 0) {
            recentOrdersTable.innerHTML = analytics.recent_orders.map(order => `
                <tr>
                    <td><span class="fw-bold">#${order.id}</span></td>
                    <td>${order.user.username}</td>
                    <td>${order.restaurant.name}</td>
                    <td><span class="fw-bold">$${parseFloat(order.total_amount).toFixed(2)}</span></td>
                    <td>
                        <span class="badge bg-${getOrderStatusColor(order.status)}">
                            ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                        </span>
                    </td>
                    <td>${new Date(order.created_at).toLocaleDateString()}</td>
                </tr>
            `).join('');
        } else {
            recentOrdersTable.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-3">
                        <ion-icon name="receipt-outline" style="font-size: 2rem; color: #ccc;"></ion-icon>
                        <p class="mt-2 text-muted small">No recent orders</p>
                    </td>
                </tr>
            `;
        }
        
        // Initialize charts for orders over time
        ensureChartJsLoaded(function(){ initializeOrderCharts(analytics); });
    }
    
    function getOrderStatusColor(status) {
        const colors = {
            'pending': 'warning',
            'confirmed': 'info',
            'preparing': 'primary',
            'ready': 'success',
            'delivered': 'success',
            'cancelled': 'secondary'
        };
        return colors[status] || 'secondary';
    }
    
    function initializeOrderCharts(analytics) {
        const series = analytics.orders_by_day || [];
        const labels = series.map(p => p.date);
        const orders = series.map(p => p.orders);
        const revenue = series.map(p => p.revenue);
        const ordersEl = document.getElementById('ordersOverTimeChart');
        const revenueEl = document.getElementById('revenueChart');
        if (ordersEl) {
            if (ordersEl._chartInstance) { try { ordersEl._chartInstance.destroy(); } catch(e) {} }
            const chart = new Chart(ordersEl, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Orders', data: orders, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.1)', tension: 0.25 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
            });
            ordersEl._chartInstance = chart;
        }
        if (revenueEl) {
            if (revenueEl._chartInstance) { try { revenueEl._chartInstance.destroy(); } catch(e) {} }
            const chart2 = new Chart(revenueEl, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Revenue', data: revenue, borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', tension: 0.25 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
            });
            revenueEl._chartInstance = chart2;
        }
    }
    
    function refreshOrderList() {
        loadOrderList();
    }
    
    // Store order data globally for filtering
    let allOrders = [];
    
    function filterOrders() {
        const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
        const statusFilter = document.getElementById('orderStatusFilter').value;
        const sortBy = document.getElementById('orderSortBy').value;
        const dateFilter = document.getElementById('orderDateFilter').value;
        
        let filteredOrders = allOrders.filter(order => {
            const matchesSearch = !searchTerm || 
                order.id.toString().includes(searchTerm) ||
                order.user.username.toLowerCase().includes(searchTerm) ||
                order.restaurant.name.toLowerCase().includes(searchTerm);
            
            const matchesStatus = !statusFilter || order.status === statusFilter;
            
            const matchesDate = !dateFilter || checkDateFilter(order.created_at, dateFilter);
            
            return matchesSearch && matchesStatus && matchesDate;
        });
        
        // Sort orders
        filteredOrders.sort((a, b) => {
            switch(sortBy) {
                case 'id':
                    return b.id - a.id;
                case 'created_at':
                    return new Date(b.created_at) - new Date(a.created_at);
                case 'total_amount':
                    return parseFloat(b.total_amount) - parseFloat(a.total_amount);
                case 'status':
                    return a.status.localeCompare(b.status);
                default:
                    return 0;
            }
        });
        
        displayOrderList(filteredOrders);
    }
    
    function checkDateFilter(dateString, filter) {
        const orderDate = new Date(dateString);
        const now = new Date();
        
        switch(filter) {
            case 'today':
                return orderDate.toDateString() === now.toDateString();
            case 'week':
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                return orderDate >= weekAgo;
            case 'month':
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                return orderDate >= monthAgo;
            default:
                return true;
        }
    }
    
    function toggleSelectAllOrders() {
        const selectAll = document.getElementById('selectAllOrders');
        const checkboxes = document.querySelectorAll('.order-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateOrderBulkActions();
    }
    
    function updateOrderBulkActions() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const bulkActions = document.getElementById('orderBulkActions');
        
        if (checkedBoxes.length > 0) {
            bulkActions.style.display = 'block';
        } else {
            bulkActions.style.display = 'none';
        }
    }
    
    function bulkUpdateOrderStatus() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        if (checkedBoxes.length === 0) {
            showNotification('Please select orders to update', 'warning');
            return;
        }
        
        showNotification('Bulk status update functionality coming soon!', 'info');
    }
    
    function bulkDeleteOrders() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        if (checkedBoxes.length === 0) {
            showNotification('Please select orders to delete', 'warning');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${checkedBoxes.length} selected orders? This action cannot be undone!`)) {
            const orderIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            fetch('/admin-api/orders/bulk-delete/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ order_ids: orderIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`${orderIds.length} orders deleted successfully`, 'success');
                    loadOrderList();
                } else {
                    showNotification('Error deleting orders: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('Error deleting orders', 'error');
            });
        }
    }
    
    function exportOrders() {
        showNotification('Export Orders functionality coming soon!', 'info');
    }
    
    // Analytics Functions
    function showUserAnalytics() {
        console.log('ðŸ”„ Showing user analytics...');
        clearAllContent();
        const content = `
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="fw-bold mb-0">User Analytics</h3>
                    <p class="text-body-secondary mb-0">Roles, activity, and distribution</p>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card border-0 shadow-sm"><div class="card-body d-flex align-items-center">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem">
                            <ion-icon name="people-outline" class="text-white" style="font-size:1.5rem"></ion-icon>
                        </div>
                        <div class="ms-3">
                            <div class="text-body-secondary small">Total Users</div>
                            <div id="uaTotalUsers" class="h4 fw-bold mb-0">0</div>
                        </div>
                    </div></div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card border-0 shadow-sm"><div class="card-body d-flex align-items-center">
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem">
                            <ion-icon name="checkmark-circle-outline" class="text-white" style="font-size:1.5rem"></ion-icon>
                        </div>
                        <div class="ms-3">
                            <div class="text-body-secondary small">Active</div>
                            <div id="uaActiveUsers" class="h4 fw-bold mb-0">0</div>
                        </div>
                    </div></div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card border-0 shadow-sm"><div class="card-body d-flex align-items-center">
                        <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem">
                            <ion-icon name="close-circle-outline" class="text-white" style="font-size:1.5rem"></ion-icon>
                        </div>
                        <div class="ms-3">
                            <div class="text-body-secondary small">Inactive</div>
                            <div id="uaInactiveUsers" class="h4 fw-bold mb-0">0</div>
                        </div>
                    </div></div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0"><h5 class="fw-bold mb-0">Users by Role</h5></div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead><tr><th>Role</th><th>Count</th></tr></thead>
                                    <tbody id="uaByRoleBody">
                                        <tr><td colspan="2" class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0"><h5 class="fw-bold mb-0">Distribution</h5></div>
                        <div class="card-body" style="height:320px">
                            <canvas id="userDistributionChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>`;
        const mainContent = document.querySelector('.admin-content .container-fluid');
        if (mainContent) {
            mainContent.innerHTML = content;
            setTimeout(loadUserAnalytics, 50);
        }
    }

    function loadUserAnalytics() {
        fetch('/admin-api/users/analytics/', {
            method: 'GET',
            headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type': 'application/json' }
        })
        .then(r=>r.json())
        .then(data=>{
            if (!data.success) { showNotification('Error loading user analytics: '+(data.error||''), 'error'); return; }
            displayUserAnalytics(data.analytics);
            // Initialize user distribution chart
            ensureChartJsLoaded(function() { initializeUserCharts(data.analytics); });
        })
        .catch(()=> showNotification('Network error loading user analytics', 'error'));
    }

    function displayUserAnalytics(analytics) {
        const total = document.getElementById('uaTotalUsers');
        const active = document.getElementById('uaActiveUsers');
        const inactive = document.getElementById('uaInactiveUsers');
        if (total) total.textContent = analytics.total_users || 0;
        if (active) active.textContent = analytics.active_users || 0;
        if (inactive) inactive.textContent = analytics.inactive_users || 0;
        const tbody = document.getElementById('uaByRoleBody');
        if (tbody) {
            const rows = (analytics.by_role||[]).map(r=>`<tr><td class="text-capitalize">${r.role}</td><td><span class="badge bg-primary">${r.count}</span></td></tr>`).join('');
            tbody.innerHTML = rows || '<tr><td colspan="2" class="text-center text-muted">No role data</td></tr>';
        }
    }
    
    function showPlatformAnalytics() {
        console.log('ðŸ”„ Showing platform analytics...');
        clearAllContent();
        const content = `
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="fw-bold mb-0">Platform Analytics</h3>
                    <p class="text-body-secondary mb-0">Overall platform performance metrics</p>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-xl-4 col-md-6 mb-3"><div class="card stats-card border-0 shadow-sm"><div class="card-body"><div class="d-flex align-items-center"><div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem"><ion-icon name="people-outline" class="text-white" style="font-size:1.5rem"></ion-icon></div><div class="ms-3"><div class="text-body-secondary small">Users</div><div id="paUsers" class="h4 fw-bold mb-0">0</div></div></div></div></div></div>
                <div class="col-xl-4 col-md-6 mb-3"><div class="card stats-card border-0 shadow-sm"><div class="card-body"><div class="d-flex align-items-center"><div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem"><ion-icon name="restaurant-outline" class="text-white" style="font-size:1.5rem"></ion-icon></div><div class="ms-3"><div class="text-body-secondary small">Restaurants</div><div id="paRestaurants" class="h4 fw-bold mb-0">0</div></div></div></div></div></div>
                <div class="col-xl-4 col-md-6 mb-3"><div class="card stats-card border-0 shadow-sm"><div class="card-body"><div class="d-flex align-items-center"><div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem"><ion-icon name="fast-food-outline" class="text-white" style="font-size:1.5rem"></ion-icon></div><div class="ms-3"><div class="text-body-secondary small">Meals</div><div id="paMeals" class="h4 fw-bold mb-0">0</div></div></div></div></div></div>
            </div>
            <div class="row mb-4">
                <div class="col-xl-6 col-md-6 mb-3"><div class="card stats-card border-0 shadow-sm"><div class="card-body"><div class="d-flex align-items-center"><div class="bg-info rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem"><ion-icon name="receipt-outline" class="text-white" style="font-size:1.5rem"></ion-icon></div><div class="ms-3"><div class="text-body-secondary small">Total Orders</div><div id="paOrders" class="h4 fw-bold mb-0">0</div></div></div></div></div></div>
                <div class="col-xl-6 col-md-6 mb-3"><div class="card stats-card border-0 shadow-sm"><div class="card-body"><div class="d-flex align-items-center"><div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem"><ion-icon name="cash-outline" class="text-white" style="font-size:1.5rem"></ion-icon></div><div class="ms-3"><div class="text-body-secondary small">Total Revenue</div><div id="paRevenue" class="h4 fw-bold mb-0">$0.00</div></div></div></div></div></div>
            </div>`;
        const mainContent = document.querySelector('.admin-content .container-fluid');
        if (mainContent) {
            mainContent.innerHTML = content;
            setTimeout(loadPlatformAnalytics, 50);
        }
    }

    function loadPlatformAnalytics() {
        fetch('/admin-api/platform/analytics/', { method:'GET', headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type':'application/json' }})
          .then(r=>r.json())
          .then(data=>{
            if (!data.success) { showNotification('Error loading platform analytics: '+(data.error||''), 'error'); return; }
            const a = data.analytics || {};
            const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
            set('paUsers', a.total_users || 0);
            set('paRestaurants', a.total_restaurants || 0);
            set('paMeals', a.total_meals || 0);
            set('paOrders', a.total_orders || 0);
            const revenue = '$' + (parseFloat(a.total_revenue)||0).toFixed(2);
            set('paRevenue', revenue);
            // Initialize platform charts (growth over time) if data available
            if (a.orders_by_day) {
                ensureChartJsLoaded(function() { initializePlatformCharts(a); });
            }
            // Also load User Distribution for the platform analytics page
            fetch('/admin-api/users/analytics/', { method:'GET', headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type':'application/json' }})
              .then(rr => rr.json())
              .then(usersData => {
                  if (usersData && usersData.success) {
                      ensureChartJsLoaded(function() { initializeUserCharts(usersData.analytics, 'platformUserDistributionChart'); });
                  }
              })
              .catch(()=>{});
          })
          .catch(()=> showNotification('Network error loading platform analytics', 'error'));
    }

    function ensureChartJsLoaded(callback) {
        if (window.Chart) { callback(); return; }
        const existing = document.getElementById('chartjs-cdn');
        if (existing) { existing.addEventListener('load', callback); return; }
        const s = document.createElement('script');
        s.id = 'chartjs-cdn';
        s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
        s.async = true;
        s.onload = callback;
        document.head.appendChild(s);
    }

    function initializePlatformCharts(analytics) {
        const series = analytics.orders_by_day || [];
        const labels = series.map(p => p.date);
        const orders = series.map(p => p.orders);
        const revenue = series.map(p => p.revenue);
        const ctx = document.getElementById('platformGrowthChart');
        if (!ctx) return;
        // Destroy existing instance if re-rendering
        if (ctx._chartInstance) { try { ctx._chartInstance.destroy(); } catch(e) {} }
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Orders',
                        data: orders,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.25,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Revenue',
                        data: revenue,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        tension: 0.25,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                stacked: false,
                plugins: {
                    legend: { position: 'bottom' }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Orders' } },
                    y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Revenue ($)' } }
                }
            }
        });
        ctx._chartInstance = chart;
    }
    
    function loadAnalyticsData() {
        console.log('ðŸ”„ Loading analytics data...');
        
        // Load order analytics
        fetch('/admin-api/orders/analytics/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateAnalyticsOverview(data.analytics);
                updateAnalyticsTables(data.analytics);
                console.log('âœ… Analytics data loaded successfully');
                // Initialize Platform Growth chart from orders analytics timeseries
                ensureChartJsLoaded(function() { initializePlatformCharts(data.analytics); });
            } else {
                console.error('âŒ Error loading analytics:', data.error);
                showNotification('Error loading analytics: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('âŒ Network error:', error);
            showNotification('Error loading analytics: ' + error.message, 'error');
        });
    }

    function initializeUserCharts(analytics, elId = 'userDistributionChart') {
        const el = document.getElementById(elId);
        if (!el) return;
        const byRole = analytics.by_role || [];
        const labels = byRole.map(r => (r.role || '').toString());
        const data = byRole.map(r => r.count || 0);
        if (el._chartInstance) { try { el._chartInstance.destroy(); } catch(e) {} }
        const chart = new Chart(el, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545','#6f42c1','#0dcaf0']
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
        el._chartInstance = chart;
    }
    
    function updateAnalyticsOverview(analytics) {
        // Update revenue
        const revenueElement = document.getElementById('analyticsTotalRevenue');
        if (revenueElement) {
            revenueElement.textContent = '$' + (analytics.total_revenue || 0).toFixed(2);
        }
    }
    
    function updateAnalyticsTables(analytics) {
        // Update recent orders table
        const recentOrdersTable = document.getElementById('analyticsRecentOrders');
        if (recentOrdersTable && analytics.recent_orders) {
            if (analytics.recent_orders.length > 0) {
                recentOrdersTable.innerHTML = analytics.recent_orders.slice(0, 5).map(order => `
                    <tr>
                        <td><span class="fw-bold">#${order.id}</span></td>
                        <td>${order.user.username}</td>
                        <td><span class="fw-bold">$${parseFloat(order.total_amount).toFixed(2)}</span></td>
                        <td>
                            <span class="badge bg-${getOrderStatusColor(order.status)}">
                                ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } else {
                recentOrdersTable.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-3">
                            <ion-icon name="receipt-outline" style="font-size: 2rem; color: #ccc;"></ion-icon>
                            <p class="mt-2 text-muted small">No recent orders</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Update top restaurants table
        const topRestaurantsTable = document.getElementById('analyticsTopRestaurants');
        if (topRestaurantsTable && analytics.top_restaurants) {
            if (analytics.top_restaurants.length > 0) {
                topRestaurantsTable.innerHTML = analytics.top_restaurants.slice(0, 5).map(restaurant => `
                    <tr>
                        <td>
                            <div class="fw-medium">${restaurant.name}</div>
                            <small class="text-muted">${restaurant.location}</small>
                        </td>
                        <td><span class="badge bg-primary">${restaurant.orders_count}</span></td>
                        <td><span class="fw-bold">$${parseFloat(restaurant.revenue).toFixed(2)}</span></td>
                    </tr>
                `).join('');
            } else {
                topRestaurantsTable.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center py-3">
                            <ion-icon name="restaurant-outline" style="font-size: 2rem; color: #ccc;"></ion-icon>
                            <p class="mt-2 text-muted small">No restaurant data available</p>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    function refreshOrders() {
        showNotification('Refreshing orders...', 'info');
        // Reload the page to refresh orders
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
    
    function searchOrders() {
        const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#ordersTable tbody tr');
        
        rows.forEach(row => {
            const orderId = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const customer = row.querySelector('h6').textContent.toLowerCase();
            const restaurant = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
            
            if (orderId.includes(searchTerm) || customer.includes(searchTerm) || restaurant.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function toggleSelectAllOrders() {
        const selectAll = document.getElementById('selectAllOrders');
        const checkboxes = document.querySelectorAll('.order-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateOrderBulkActions();
    }
    
    function updateOrderBulkActions() {
        const checkboxes = document.querySelectorAll('.order-checkbox:checked');
        const bulkActions = document.getElementById('orderBulkActions');
        const selectedCount = document.getElementById('selectedOrderCount');
        
        if (checkboxes.length > 0) {
            bulkActions.style.display = 'block';
            selectedCount.textContent = checkboxes.length;
        } else {
            bulkActions.style.display = 'none';
        }
    }
    
    function bulkUpdateStatus() {
        const checkboxes = document.querySelectorAll('.order-checkbox:checked');
        if (checkboxes.length === 0) {
            showNotification('Please select orders first', 'warning');
            return;
        }
        
        const orderIds = Array.from(checkboxes).map(cb => cb.value);
        const newStatus = prompt(`Update status for ${orderIds.length} selected orders:\n\nEnter new status (pending, confirmed, preparing, ready, delivered, cancelled):`);
        
        if (newStatus && ['pending', 'confirmed', 'preparing', 'ready', 'delivered', 'cancelled'].includes(newStatus.toLowerCase())) {
            showNotification(`Bulk updating ${orderIds.length} orders to ${newStatus} - Coming soon!`, 'info');
        }
    }
    
    function bulkExportOrders() {
        const checkboxes = document.querySelectorAll('.order-checkbox:checked');
        if (checkboxes.length === 0) {
            showNotification('Please select orders first', 'warning');
            return;
        }
        
        const orderIds = Array.from(checkboxes).map(cb => cb.value);
        showNotification(`Exporting ${orderIds.length} selected orders - Coming soon!`, 'info');
    }
    
    function bulkDeleteOrders() {
        const checkboxes = document.querySelectorAll('.order-checkbox:checked');
        if (checkboxes.length === 0) {
            showNotification('Please select orders first', 'warning');
            return;
        }
        
        const orderIds = Array.from(checkboxes).map(cb => cb.value);
        const action = confirm(`Delete ${orderIds.length} selected orders? This action cannot be undone!`);
        
        if (action) {
            showNotification(`Bulk delete for ${orderIds.length} orders - Coming soon!`, 'info');
        }
    }
    
    // Add event listeners for order checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('order-checkbox')) {
            updateOrderBulkActions();
        }
    });
    
    // Add event listener for order search input
    document.addEventListener('input', function(e) {
        if (e.target.id === 'orderSearchInput') {
            searchOrders();
        }
    });
    
    // Add event listeners for order filter dropdowns
    document.addEventListener('change', function(e) {
        if (e.target.id === 'orderStatusFilter' || e.target.id === 'orderDateFilter') {
            filterOrders();
        }
    });
    
    function filterOrders() {
        const statusFilter = document.getElementById('orderStatusFilter').value;
        const dateFilter = document.getElementById('orderDateFilter').value;
        const rows = document.querySelectorAll('#ordersTable tbody tr');
        
        rows.forEach(row => {
            const orderStatus = row.getAttribute('data-status');
            const orderDate = row.getAttribute('data-date');
            
            let showRow = true;
            
            if (statusFilter && orderStatus !== statusFilter) {
                showRow = false;
            }
            
            if (dateFilter) {
                const today = new Date();
                const orderDateObj = new Date(orderDate);
                
                switch(dateFilter) {
                    case 'today':
                        if (orderDateObj.toDateString() !== today.toDateString()) {
                            showRow = false;
                        }
                        break;
                    case 'week':
                        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        if (orderDateObj < weekAgo) {
                            showRow = false;
                        }
                        break;
                    case 'month':
                        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                        if (orderDateObj < monthAgo) {
                            showRow = false;
                        }
                        break;
                }
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    }
    
    // Restaurant Management Functions
    function showRestaurantList() {
        // Create restaurant list content
        const content = `
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="fw-bold mb-0">All Restaurants</h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshRestaurantList()">
                                <ion-icon name="refresh-outline" class="me-1"></ion-icon>
                                Refresh
                            </button>
                            <button class="btn btn-success" onclick="showAddRestaurantModal()">
                                <ion-icon name="add-outline" class="me-1"></ion-icon>
                                Add Restaurant
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <ion-icon name="search-outline"></ion-icon>
                        </span>
                        <input type="text" class="form-control" id="restaurantSearch" placeholder="Search restaurants...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="restaurantStatusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="restaurantSortBy">
                        <option value="name">Sort by Name</option>
                        <option value="created_at">Sort by Date</option>
                        <option value="orders_count">Sort by Orders</option>
                    </select>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="restaurantsTable">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAllRestaurants" onchange="toggleSelectAllRestaurants()">
                                    </th>
                                    <th>Restaurant</th>
                                    <th>Owner</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Orders</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="restaurantsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading restaurants...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3" id="restaurantBulkActions" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3">
                                <span class="text-muted">Bulk Actions:</span>
                                <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteRestaurants()">
                                    <ion-icon name="trash-outline" class="me-1"></ion-icon>
                                    Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Create and display the content directly
        const mainContent = document.querySelector('.admin-content .container-fluid');
        if (mainContent) {
            mainContent.innerHTML = content;
            
            // Load restaurant data after content is created
            setTimeout(() => {
                loadRestaurantList();
                addRestaurantManagementEventListeners();
            }, 100);
        } else {
            console.error('âŒ Main content container not found!');
        }
    }
    
    function showAddRestaurantModal() {
        // Create add restaurant modal
        const modal = `
            <div class="modal fade" id="addRestaurantModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <ion-icon name="add-outline" class="me-2"></ion-icon>
                                Add New Restaurant
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addRestaurantForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Restaurant Name</label>
                                        <input type="text" class="form-control" id="restaurantName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Owner Email</label>
                                        <input type="email" class="form-control" id="ownerEmail" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Phone Number</label>
                                        <input type="tel" class="form-control" id="restaurantPhone">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Location</label>
                                        <input type="text" class="form-control" id="restaurantLocation" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Description</label>
                                    <textarea class="form-control" id="restaurantDescription" rows="3"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Delivery Time</label>
                                        <input type="text" class="form-control" id="deliveryTime" placeholder="e.g., 30-45 minutes">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Opening Hours</label>
                                        <input type="text" class="form-control" id="openingHours" placeholder="e.g., Mon-Sun: 9:00 AM - 10:00 PM">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="saveNewRestaurant()">
                                <ion-icon name="save-outline" class="me-1"></ion-icon>
                                Create Restaurant
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('addRestaurantModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modal);
        
        // Show modal
        const modalElement = new bootstrap.Modal(document.getElementById('addRestaurantModal'));
        modalElement.show();
    }
    
    function showRestaurantAnalytics() {
        // Create restaurant analytics content
        const content = `
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="fw-bold mb-0">Restaurant Analytics</h3>
                    <p class="text-body-secondary mb-0">Performance metrics and insights for all restaurants</p>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="totalRestaurantsCount">-</h4>
                                    <p class="mb-0">Total Restaurants</p>
                                </div>
                                <ion-icon name="restaurant-outline" style="font-size: 2rem;"></ion-icon>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="activeRestaurantsCount">-</h4>
                                    <p class="mb-0">Active Restaurants</p>
                                </div>
                                <ion-icon name="checkmark-circle-outline" style="font-size: 2rem;"></ion-icon>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="totalOrdersCount">-</h4>
                                    <p class="mb-0">Total Orders</p>
                                </div>
                                <ion-icon name="receipt-outline" style="font-size: 2rem;"></ion-icon>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="avgOrderValue">-</h4>
                                    <p class="mb-0">Avg Order Value</p>
                                </div>
                                <ion-icon name="cash-outline" style="font-size: 2rem;"></ion-icon>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Top Performing Restaurants</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="topRestaurantsTable">
                                    <thead>
                                        <tr>
                                            <th>Restaurant</th>
                                            <th>Orders</th>
                                            <th>Revenue</th>
                                            <th>Rating</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topRestaurantsTableBody">
                                        <tr>
                                            <td colspan="4" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Restaurant Status Distribution</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="restaurantStatusChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Create and display the content directly
        const mainContent = document.querySelector('.admin-content .container-fluid');
        if (mainContent) {
            mainContent.innerHTML = content;
            
            // Load analytics data after content is created
            setTimeout(() => {
                loadRestaurantAnalytics();
            }, 100);
        } else {
            console.error('âŒ Main content container not found!');
        }
    }
    
    // Supporting functions for restaurant management
    function loadRestaurantList() {
        console.log('ðŸ”„ Loading restaurant list...');
        
        // Check if the table body exists
        const tbody = document.getElementById('restaurantsTableBody');
        if (!tbody) {
            console.error('âŒ Restaurant table body not found!');
            showNotification('Restaurant table not ready. Please try again.', 'error');
            return;
        }
        
        fetch('/admin-api/restaurants/list/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('ðŸ“Š Restaurant data received:', data);
            if (data.success) {
                allRestaurants = data.restaurants; // Store globally for filtering
                displayRestaurantList(data.restaurants);
                console.log('âœ… Restaurant list displayed successfully');
            } else {
                console.error('âŒ Error from server:', data.error);
                showNotification('Error loading restaurants: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('âŒ Network error:', error);
            showNotification('Error loading restaurants: ' + error.message, 'error');
        });
    }
    
    function displayRestaurantList(restaurants) {
        const tbody = document.getElementById('restaurantsTableBody');
        if (restaurants.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <ion-icon name="restaurant-outline" style="font-size: 3rem; color: #ccc;"></ion-icon>
                        <p class="mt-2 text-muted">No restaurants found</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = restaurants.map(restaurant => `
            <tr data-restaurant-id="${restaurant.id}" data-restaurant-name="${restaurant.name}" data-restaurant-status="active">
                <td>
                    <input type="checkbox" class="restaurant-checkbox" value="${restaurant.id}">
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            ${restaurant.logo ? 
                                `<img src="${restaurant.logo}" alt="${restaurant.name}" class="rounded" style="width: 40px; height: 40px; object-fit: cover;">` :
                                `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <ion-icon name="restaurant-outline" style="font-size: 1.5rem; color: #ccc;"></ion-icon>
                                </div>`
                            }
                        </div>
                        <div>
                            <div class="fw-bold">
                                <a href="/restaurants/detail/${restaurant.id}/" class="text-decoration-none text-primary" target="_blank" title="View Restaurant Details">
                                    ${restaurant.name}
                                    <ion-icon name="open-outline" class="ms-1" style="font-size: 14px;"></ion-icon>
                                </a>
                            </div>
                            <small class="text-muted">${restaurant.description || 'No description'}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div>
                        <div class="fw-medium">${restaurant.owner_name || 'N/A'}</div>
                        <small class="text-muted">${restaurant.owner_email || ''}</small>
                    </div>
                </td>
                <td>
                    <span class="text-truncate d-inline-block" style="max-width: 150px;" title="${restaurant.location}">
                        ${restaurant.location || 'N/A'}
                    </span>
                </td>
                <td>
                    <span class="badge bg-success">
                        Active
                    </span>
                </td>
                <td>
                    <span class="fw-bold">${restaurant.orders_count || 0}</span>
                </td>
                <td>
                    <small class="text-muted">${new Date(restaurant.created_at).toLocaleDateString()}</small>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="showRestaurantEditModal(${restaurant.id}, '${restaurant.name}')" title="Edit">
                            <ion-icon name="create-outline"></ion-icon>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRestaurant(${restaurant.id}, '${restaurant.name}')" title="Delete">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        // Add event listeners for checkboxes
        document.querySelectorAll('.restaurant-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateRestaurantBulkActions);
        });
    }
    
    function loadRestaurantAnalytics() {
        fetch('/admin-api/restaurants/analytics/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRestaurantAnalytics(data.analytics);
                ensureChartJsLoaded(function(){
                    initializeRestaurantCharts(data.analytics);
                    initializeRestaurantStatusChart(data.analytics);
                });
            } else {
                showNotification('Error loading analytics: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Error loading analytics', 'error');
        });
    }
    
    function displayRestaurantAnalytics(analytics) {
        // Update stats cards
        document.getElementById('totalRestaurantsCount').textContent = analytics.total_restaurants || 0;
        document.getElementById('activeRestaurantsCount').textContent = analytics.active_restaurants || 0;
        document.getElementById('totalOrdersCount').textContent = analytics.total_orders || 0;
        const aovRestaurants = parseFloat(analytics.avg_order_value);
        document.getElementById('avgOrderValue').textContent = '$' + (isNaN(aovRestaurants) ? 0 : aovRestaurants).toFixed(2);
        
        // Update top restaurants table
        const tbody = document.getElementById('topRestaurantsTableBody');
        if (analytics.top_restaurants && analytics.top_restaurants.length > 0) {
            tbody.innerHTML = analytics.top_restaurants.map(restaurant => `
                <tr>
                    <td>
                        <div class="fw-bold">
                            <a href="/restaurants/detail/${restaurant.id}/" class="text-decoration-none text-primary" target="_blank" title="View Restaurant Details">
                                ${restaurant.name}
                                <ion-icon name="open-outline" class="ms-1" style="font-size: 14px;"></ion-icon>
                            </a>
                        </div>
                        <small class="text-muted">${restaurant.location}</small>
                    </td>
                    <td><span class="badge bg-primary">${restaurant.orders_count}</span></td>
                    <td><span class="fw-bold">$${restaurant.revenue || 0}</span></td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="d-flex align-items-center">
                                <span class="me-1">${(restaurant.rating ?? 0).toFixed ? restaurant.rating.toFixed(1) : restaurant.rating}</span>
                                <ion-icon name="star" style="color: #ffc107;"></ion-icon>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showEditRestaurantRatingModal(${restaurant.id}, ${restaurant.rating ?? 0})">
                                <ion-icon name="create-outline"></ion-icon>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <p class="text-muted">No data available</p>
                    </td>
                </tr>
            `;
        }
    }

    // Modal to edit restaurant rating
    function showEditRestaurantRatingModal(restaurantId, currentRating) {
        const modalHtml = `
            <div class="modal fade" id="editRestaurantRatingModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Edit Restaurant Rating</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <label class="form-label">Overall Rating (0.0 - 5.0)</label>
                    <input type="number" class="form-control" id="editRestaurantRatingInput" min="0" max="5" step="0.1" value="${currentRating || 0}">
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRestaurantRating(${restaurantId})">Save</button>
                  </div>
                </div>
              </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('editRestaurantRatingModal'));
        modal.show();
        document.getElementById('editRestaurantRatingModal').addEventListener('hidden.bs.modal', () => {
            document.getElementById('editRestaurantRatingModal').remove();
        });
    }

    function saveRestaurantRating(restaurantId) {
        const input = document.getElementById('editRestaurantRatingInput');
        const rating = parseFloat(input.value);
        if (isNaN(rating) || rating < 0 || rating > 5) {
            showNotification('Please enter a rating between 0.0 and 5.0', 'warning');
            return;
        }
        fetch(`/admin-api/restaurants/${restaurantId}/update-rating/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rating })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showNotification('Rating updated successfully', 'success');
                // Close modal and refresh analytics table
                const modalEl = document.getElementById('editRestaurantRatingModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                }
                // Reload analytics to reflect new rating
                loadRestaurantAnalytics();
            } else {
                showNotification('Error updating rating: ' + data.error, 'error');
            }
        })
        .catch(() => showNotification('Network error updating rating', 'error'));
    }
    
    function saveNewRestaurant() {
        const formData = {
            name: document.getElementById('restaurantName').value,
            owner_email: document.getElementById('ownerEmail').value,
            phone: document.getElementById('restaurantPhone').value,
            location: document.getElementById('restaurantLocation').value,
            description: document.getElementById('restaurantDescription').value,
            delivery_time: document.getElementById('deliveryTime').value,
            opening_hours: document.getElementById('openingHours').value
        };
        
        fetch('/admin-api/restaurants/create/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Restaurant created successfully!', 'success');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addRestaurantModal'));
                modal.hide();
                // Refresh the page to show the new user
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error creating restaurant: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Error creating restaurant', 'error');
        });
    }
    
    function refreshRestaurantList() {
        loadRestaurantList();
    }
    
    // Store restaurant data globally for filtering
    let allRestaurants = [];
    
    function filterRestaurants() {
        const searchTerm = document.getElementById('restaurantSearch').value.toLowerCase();
        const statusFilter = document.getElementById('restaurantStatusFilter').value;
        const sortBy = document.getElementById('restaurantSortBy').value;
        
        let filteredRestaurants = [...allRestaurants];
        
        // Filter by search term
        if (searchTerm) {
            filteredRestaurants = filteredRestaurants.filter(restaurant => 
                restaurant.name.toLowerCase().includes(searchTerm) ||
                restaurant.description.toLowerCase().includes(searchTerm) ||
                restaurant.location.toLowerCase().includes(searchTerm) ||
                restaurant.owner_name.toLowerCase().includes(searchTerm)
            );
        }
        
        // Filter by status (since all restaurants are active by default, this filter is mainly for future use)
        if (statusFilter) {
            // All restaurants are considered active, so no filtering needed
            // This is kept for future implementation if is_active field is added
        }
        
        // Sort restaurants
        filteredRestaurants.sort((a, b) => {
            switch (sortBy) {
                case 'name':
                    return a.name.localeCompare(b.name);
                case 'created_at':
                    return new Date(b.created_at) - new Date(a.created_at);
                case 'orders_count':
                    return (b.orders_count || 0) - (a.orders_count || 0);
                default:
                    return 0;
            }
        });
        
        // Display filtered results
        displayRestaurantList(filteredRestaurants);
    }
    
    function toggleSelectAllRestaurants() {
        const selectAll = document.getElementById('selectAllRestaurants');
        const checkboxes = document.querySelectorAll('.restaurant-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateRestaurantBulkActions();
    }
    
    function updateRestaurantBulkActions() {
        const checkedBoxes = document.querySelectorAll('.restaurant-checkbox:checked');
        const bulkActions = document.getElementById('restaurantBulkActions');
        
        if (checkedBoxes.length > 0) {
            bulkActions.style.display = 'block';
        } else {
            bulkActions.style.display = 'none';
        }
    }
    
    
    function bulkDeleteRestaurants() {
        const checkedBoxes = document.querySelectorAll('.restaurant-checkbox:checked');
        if (checkedBoxes.length === 0) {
            showNotification('Please select restaurants to delete', 'warning');
            return;
        }
        
        if (!confirm(`Are you sure you want to delete ${checkedBoxes.length} restaurants? This action cannot be undone.`)) {
            return;
        }
        
        const restaurantIds = Array.from(checkedBoxes).map(cb => cb.value);
        
        fetch('/admin-api/restaurants/bulk-delete/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ restaurant_ids: restaurantIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`${restaurantIds.length} restaurants deleted successfully`, 'success');
                loadRestaurantList();
            } else {
                showNotification('Error deleting restaurants: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Error deleting restaurants', 'error');
        });
    }
    
    function showRestaurantEditModal(restaurantId, restaurantName) {
        // Fetch restaurant data and show edit modal
        fetch(`/admin-api/restaurants/${restaurantId}/edit/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showRestaurantEditForm(data.restaurant);
            } else {
                showNotification(data.error || 'Failed to load restaurant data', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to load restaurant data', 'error');
        });
    }
    
    function showRestaurantEditForm(restaurant) {
        const modalHtml = `
            <div class="modal fade" id="restaurantEditModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <ion-icon name="create-outline" class="me-2"></ion-icon>
                                Edit Restaurant: ${restaurant.name}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="restaurantEditForm" enctype="multipart/form-data">
                                <!-- Basic Information -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="fw-bold text-primary mb-3">
                                            <ion-icon name="restaurant-outline" class="me-2"></ion-icon>
                                            Basic Information
                                        </h6>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Restaurant Name</label>
                                        <input type="text" class="form-control" id="editRestaurantName" value="${restaurant.name}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Location</label>
                                        <input type="text" class="form-control" id="editRestaurantLocation" value="${restaurant.location || ''}">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <label class="form-label fw-bold">Description</label>
                                        <textarea class="form-control" id="editRestaurantDescription" rows="3" placeholder="Enter restaurant description">${restaurant.description || ''}</textarea>
                                    </div>
                                </div>

                                <!-- Logo Section -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="fw-bold text-primary mb-3">
                                            <ion-icon name="image-outline" class="me-2"></ion-icon>
                                            Restaurant Logo
                                        </h6>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Current Logo</label>
                                        <div class="border rounded p-3 text-center" style="max-width: 200px;">
                                            ${restaurant.logo ? 
                                                `<img src="${restaurant.logo}" alt="Current logo" class="img-fluid rounded" style="max-height: 100px;">
                                                 <p class="small text-muted mt-2 mb-0">Current Logo</p>` :
                                                `<div class="text-muted">
                                                    <ion-icon name="image-outline" style="font-size: 3rem; color: #ccc;"></ion-icon>
                                                    <p class="small mt-2 mb-0">No logo uploaded</p>
                                                 </div>`
                                            }
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Upload New Logo</label>
                                        <input type="file" class="form-control" id="editRestaurantLogo" accept="image/*">
                                        <div class="form-text">Upload a new logo to replace the current one</div>
                                    </div>
                                </div>

                                <!-- Hero Section -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="fw-bold text-primary mb-3">
                                            <ion-icon name="desktop-outline" class="me-2"></ion-icon>
                                            Hero Section (Meal List Page)
                                        </h6>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Current Hero Image</label>
                                        <div class="border rounded p-3 text-center" style="max-width: 200px;">
                                            ${restaurant.hero_image ? 
                                                `<img src="${restaurant.hero_image}" alt="Current hero image" class="img-fluid rounded" style="max-height: 100px;">
                                                 <p class="small text-muted mt-2 mb-0">Current Hero Image</p>` :
                                                `<div class="text-muted">
                                                    <ion-icon name="image-outline" style="font-size: 3rem; color: #ccc;"></ion-icon>
                                                    <p class="small mt-2 mb-0">No hero image</p>
                                                 </div>`
                                            }
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Upload New Hero Image</label>
                                        <input type="file" class="form-control" id="editRestaurantHeroImage" accept="image/*">
                                        <div class="form-text">Upload a new hero image for the meal list page</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Hero Title</label>
                                        <input type="text" class="form-control" id="editRestaurantHeroTitle" value="${restaurant.hero_title || ''}" placeholder="e.g., Delicious Meals">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Hero Description</label>
                                        <textarea class="form-control" id="editRestaurantHeroDescription" rows="2" placeholder="Enter hero description">${restaurant.hero_description || ''}</textarea>
                                    </div>
                                </div>

                                <!-- Contact Information -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="fw-bold text-primary mb-3">
                                            <ion-icon name="call-outline" class="me-2"></ion-icon>
                                            Contact Information
                                        </h6>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Phone Number</label>
                                        <input type="text" class="form-control" id="editRestaurantPhone" value="${restaurant.phone_number || ''}" placeholder="Enter phone number">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Email</label>
                                        <input type="email" class="form-control" id="editRestaurantEmail" value="${restaurant.email || ''}" placeholder="Enter email address">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Delivery Time</label>
                                        <input type="text" class="form-control" id="editRestaurantDeliveryTime" value="${restaurant.delivery_time || ''}" placeholder="e.g., 30-45 minutes">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Opening Hours</label>
                                        <input type="text" class="form-control" id="editRestaurantOpeningHours" value="${restaurant.opening_hours || ''}" placeholder="e.g., Mon-Sun: 9:00 AM - 10:00 PM">
                                    </div>
                                </div>

                                <!-- Owner Information (Read-only) -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="fw-bold text-primary mb-3">
                                            <ion-icon name="person-outline" class="me-2"></ion-icon>
                                            Owner Information
                                        </h6>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Owner Name</label>
                                        <input type="text" class="form-control" value="${restaurant.owner_name || 'N/A'}" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Owner Email</label>
                                        <input type="email" class="form-control" value="${restaurant.owner_email || 'N/A'}" readonly>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveRestaurantEdit(${restaurant.id})">
                                <ion-icon name="save-outline" class="me-1"></ion-icon>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('restaurantEditModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('restaurantEditModal'));
        modal.show();
    }
    
    function saveRestaurantEdit(restaurantId) {
        // Create FormData for file uploads
        const formData = new FormData();
        formData.append('name', document.getElementById('editRestaurantName').value);
        formData.append('location', document.getElementById('editRestaurantLocation').value);
        formData.append('description', document.getElementById('editRestaurantDescription').value);
        formData.append('phone_number', document.getElementById('editRestaurantPhone').value);
        formData.append('email', document.getElementById('editRestaurantEmail').value);
        formData.append('delivery_time', document.getElementById('editRestaurantDeliveryTime').value);
        formData.append('opening_hours', document.getElementById('editRestaurantOpeningHours').value);
        formData.append('hero_title', document.getElementById('editRestaurantHeroTitle').value);
        formData.append('hero_description', document.getElementById('editRestaurantHeroDescription').value);
        
        // Handle file uploads
        const logoFile = document.getElementById('editRestaurantLogo').files[0];
        if (logoFile) {
            formData.append('logo', logoFile);
        }
        
        const heroImageFile = document.getElementById('editRestaurantHeroImage').files[0];
        if (heroImageFile) {
            formData.append('hero_image', heroImageFile);
        }
        
        fetch(`/admin-api/restaurants/${restaurantId}/edit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('restaurantEditModal'));
                modal.hide();
                // Refresh the page to show updated data
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error || 'Failed to update restaurant', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to update restaurant', 'error');
        });
    }
    
    function deleteRestaurant(restaurantId, restaurantName) {
        if (confirm(`Are you sure you want to delete restaurant "${restaurantName}"? This action cannot be undone.`)) {
            fetch(`/admin-api/restaurants/${restaurantId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Restaurant "${restaurantName}" deleted successfully!`, 'success');
                    // Refresh restaurant list if it's open
                    if (document.getElementById('restaurantsTableBody')) {
                        loadRestaurantList();
                    }
                } else {
                    showNotification('Error deleting restaurant: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to delete restaurant', 'error');
            });
        }
    }
    
    // Meal Management Functions
    function showMealList() {
        console.log('ðŸ”„ Showing meal list...');
        clearAllContent();
        const content = `
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="fw-bold mb-0">All Meals</h3>
                    <p class="text-body-secondary mb-0">View and manage all meals across restaurants</p>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4 mb-2">
                    <input id="mealSearch" type="text" class="form-control" placeholder="Search by meal or restaurant">
                </div>
                <div class="col-md-3 mb-2">
                    <select id="mealAvailabilityFilter" class="form-select">
                        <option value="">All Availability</option>
                        <option value="available">Available</option>
                        <option value="unavailable">Unavailable</option>
                    </select>
                </div>
                <div class="col-md-3 mb-2">
                    <select id="mealSortBy" class="form-select">
                        <option value="recent">Most Recent</option>
                        <option value="price_asc">Price: Low to High</option>
                        <option value="price_desc">Price: High to Low</option>
                        <option value="name">Name</option>
                    </select>
                </div>
                <div class="col-md-2 mb-2 text-md-end">
                    <button class="btn btn-outline-secondary" onclick="refreshMealList()">
                        <ion-icon name="refresh-outline" class="me-1"></ion-icon>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Meal</th>
                                    <th>Restaurant</th>
                                    <th>Price</th>
                                    <th>Availability</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mealsTableBody">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading meals...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        const mainContent = document.querySelector('.admin-content .container-fluid');
        if (mainContent) {
            mainContent.innerHTML = content;
            setTimeout(() => {
                loadMealList();
                addMealManagementEventListeners();
            }, 100);
        }
    }

    function loadMealList() {
        fetch('/admin-api/meals/list/', {
            method: 'GET',
            headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                allMeals = data.meals;
                displayMealList(allMeals);
            } else {
                showNotification('Error loading meals: ' + data.error, 'error');
            }
        })
        .catch(() => showNotification('Network error loading meals', 'error'));
    }

    let allMeals = [];
    function displayMealList(meals) {
        const tbody = document.getElementById('mealsTableBody');
        if (!meals.length) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4">No meals found</td></tr>`;
            return;
        }
        tbody.innerHTML = meals.map(m => `
            <tr data-meal-id="${m.id}" data-available="${m.is_available ? 'yes' : 'no'}">
                <td>#${m.id}</td>
                <td class="fw-medium">${m.name}</td>
                <td>${m.restaurant.name}</td>
                <td>$${m.price.toFixed(2)}</td>
                <td>
                    <span class="badge ${m.is_available ? 'bg-success' : 'bg-secondary'}">${m.is_available ? 'Available' : 'Unavailable'}</span>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary edit-meal-btn" data-meal-id="${m.id}" title="Edit Meal">
                            <ion-icon name="create-outline"></ion-icon>
                        </button>
                        <button class="btn btn-sm btn-outline-warning toggle-meal-availability-btn" data-meal-id="${m.id}" title="Toggle Availability">
                            <ion-icon name="power-outline"></ion-icon>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-meal-btn" data-meal-id="${m.id}" title="Delete Meal">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function addMealManagementEventListeners() {
        const tbody = document.getElementById('mealsTableBody');
        if (tbody && !tbody.dataset.listenersAttached) {
            tbody.addEventListener('click', function(e) {
                const editBtn = e.target.closest('.edit-meal-btn');
                const toggleBtn = e.target.closest('.toggle-meal-availability-btn');
                const deleteBtn = e.target.closest('.delete-meal-btn');
                if (editBtn) {
                    const id = editBtn.getAttribute('data-meal-id');
                    showMealEditModal(id);
                    return;
                }
                if (toggleBtn) {
                    const id = toggleBtn.getAttribute('data-meal-id');
                    toggleMealAvailability(id);
                    return;
                }
                if (deleteBtn) {
                    const id = deleteBtn.getAttribute('data-meal-id');
                    deleteMeal(id);
                    return;
                }
            });
            tbody.dataset.listenersAttached = 'true';
        }
        const search = document.getElementById('mealSearch');
        const avail = document.getElementById('mealAvailabilityFilter');
        const sort = document.getElementById('mealSortBy');
        if (search) search.addEventListener('input', filterMeals);
        if (avail) avail.addEventListener('change', filterMeals);
        if (sort) sort.addEventListener('change', filterMeals);
    }

    function filterMeals() {
        const term = (document.getElementById('mealSearch')?.value || '').toLowerCase();
        const avail = document.getElementById('mealAvailabilityFilter')?.value || '';
        const sortBy = document.getElementById('mealSortBy')?.value || 'recent';
        let filtered = allMeals.filter(m =>
            m.name.toLowerCase().includes(term) || (m.restaurant.name || '').toLowerCase().includes(term)
        );
        if (avail === 'available') filtered = filtered.filter(m => m.is_available);
        if (avail === 'unavailable') filtered = filtered.filter(m => !m.is_available);
        switch (sortBy) {
            case 'price_asc': filtered.sort((a,b)=>a.price-b.price); break;
            case 'price_desc': filtered.sort((a,b)=>b.price-a.price); break;
            case 'name': filtered.sort((a,b)=>a.name.localeCompare(b.name)); break;
            default: filtered.sort((a,b)=>b.id-a.id);
        }
        displayMealList(filtered);
    }

    function refreshMealList() { loadMealList(); }

    function toggleMealAvailability(mealId) {
        fetch(`/admin-api/meals/${mealId}/toggle-availability/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type': 'application/json' }
        })
        .then(r=>r.json())
        .then(data=>{
            if (data.success) {
                showNotification('Meal availability updated','success');
                // Refresh the appropriate table depending on current view
                if (document.getElementById('mealsByRestaurantTableBody')) {
                    loadMealsForSelectedRestaurant();
                } else if (document.getElementById('mealsTableBody')) {
                    loadMealList();
                }
            }
            else { showNotification(data.error||'Failed to update availability','error'); }
        })
        .catch(()=>showNotification('Network error updating availability','error'));
    }

    function deleteMeal(mealId) {
        if (!confirm('Delete this meal?')) return;
        fetch(`/admin-api/meals/${mealId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type': 'application/json' }
        })
        .then(r=>r.json())
        .then(data=>{
            if (data.success) { showNotification('Meal deleted','success'); loadMealList(); }
            else { showNotification(data.error||'Failed to delete meal','error'); }
        })
        .catch(()=>showNotification('Network error deleting meal','error'));
    }
    
    function showAddMealModal() {
        const modalHtml = `
        <div class="modal fade" id="addMealModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add New Meal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="addMealForm">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Meal Name</label>
                      <input type="text" class="form-control" id="mealName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Price ($)</label>
                      <input type="number" class="form-control" id="mealPrice" step="0.01" min="0" required>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="mealDescription" rows="3"></textarea>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Restaurant</label>
                      <select class="form-select" id="mealRestaurant" required></select>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Image</label>
                      <input type="file" class="form-control" id="mealImage" accept="image/*">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Prep Time Min (min)</label>
                      <input type="number" class="form-control" id="prepTimeMin" min="0" value="15">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Prep Time Max (min)</label>
                      <input type="number" class="form-control" id="prepTimeMax" min="0" value="20">
                    </div>
                  </div>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="mealIsAvailable" checked>
                    <label class="form-check-label">Available for Order</label>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewMeal()">Save Meal</button>
              </div>
            </div>
          </div>
        </div>`;
        const existing = document.getElementById('addMealModal');
        if (existing) existing.remove();
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('addMealModal'));
        modal.show();
        // Populate restaurants select
        fetch('/admin-api/restaurants/list/', { method: 'GET', headers: { 'X-CSRFToken': getCSRFToken() }})
          .then(r=>r.json()).then(data=>{
            if (data.success) {
              const sel = document.getElementById('mealRestaurant');
              sel.innerHTML = data.restaurants.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
            }
          });
    }

    function saveNewMeal() {
        const name = document.getElementById('mealName').value.trim();
        const price = document.getElementById('mealPrice').value;
        const description = document.getElementById('mealDescription').value;
        const restaurantId = document.getElementById('mealRestaurant').value;
        const imageFile = document.getElementById('mealImage').files[0];
        const prepMin = document.getElementById('prepTimeMin').value;
        const prepMax = document.getElementById('prepTimeMax').value;
        const isAvailable = document.getElementById('mealIsAvailable').checked;
        if (!name || !price || !restaurantId) {
            showNotification('Please fill all required fields', 'warning');
            return;
        }
        const fd = new FormData();
        fd.append('name', name);
        fd.append('price', price);
        fd.append('description', description);
        fd.append('restaurant_id', restaurantId);
        fd.append('is_available', isAvailable ? 'true' : 'false');
        fd.append('prep_time_min', prepMin);
        fd.append('prep_time_max', prepMax);
        if (imageFile) fd.append('image', imageFile);
        fetch('/admin-api/meals/create/', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            body: fd
        })
        .then(r=>r.json())
        .then(data=>{
            if (data.success) {
                showNotification('Meal created successfully', 'success');
                const modalEl = document.getElementById('addMealModal');
                if (modalEl) { const m = bootstrap.Modal.getInstance(modalEl); m.hide(); }
                // Refresh meal list if visible
                if (document.getElementById('mealsTableBody')) loadMealList();
            } else {
                showNotification(data.error || 'Failed to create meal', 'error');
            }
        })
        .catch(()=>showNotification('Network error creating meal', 'error'));
    }
    
    function showMealsByRestaurant() {
        console.log('ðŸ”„ Showing meals by restaurant...');
        clearAllContent();
        const content = `
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="fw-bold mb-0">Meals by Restaurant</h3>
                    <p class="text-body-secondary mb-0">Select a restaurant to view its meals</p>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6 mb-2">
                    <select id="mealsRestaurantSelect" class="form-select">
                        <option value="">Select a restaurant...</option>
                    </select>
                </div>
                <div class="col-md-6 mb-2 text-md-end">
                    <button class="btn btn-outline-secondary" onclick="refreshMealsByRestaurant()">
                        <ion-icon name="refresh-outline" class="me-1"></ion-icon>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Meal</th>
                                    <th>Price</th>
                                    <th>Availability</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mealsByRestaurantTableBody">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="text-muted">Select a restaurant to view meals</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        const mainContent = document.querySelector('.admin-content .container-fluid');
        if (mainContent) {
            mainContent.innerHTML = content;
            // Load restaurants for selector
            fetch('/admin-api/restaurants/list/', { method: 'GET', headers: { 'X-CSRFToken': getCSRFToken() }})
                .then(r=>r.json()).then(data=>{
                    if (data.success) {
                        const sel = document.getElementById('mealsRestaurantSelect');
                        sel.innerHTML = '<option value="">Select a restaurant...</option>' + data.restaurants.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
                        sel.addEventListener('change', loadMealsForSelectedRestaurant);
                        addMealsByRestaurantEventListeners();
                    }
                });
        }
    }

    function loadMealsForSelectedRestaurant() {
        const restId = document.getElementById('mealsRestaurantSelect').value;
        const tbody = document.getElementById('mealsByRestaurantTableBody');
        if (!restId) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Select a restaurant to view meals</td></tr>`;
            return;
        }
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>`;
        fetch(`/admin-api/meals/list/?restaurant_id=${encodeURIComponent(restId)}`, { method:'GET', headers: { 'X-CSRFToken': getCSRFToken() }})
            .then(r=>r.json()).then(data=>{
                if (data.success) {
                    const rows = data.meals.map(m=>`
                        <tr data-meal-id="${m.id}">
                            <td>#${m.id}</td>
                            <td class="fw-medium">${m.name}</td>
                            <td>$${m.price.toFixed(2)}</td>
                            <td><span class="badge ${m.is_available ? 'bg-success' : 'bg-secondary'}">${m.is_available ? 'Available' : 'Unavailable'}</span></td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary edit-meal-btn" data-meal-id="${m.id}" title="Edit Meal">
                                        <ion-icon name="create-outline"></ion-icon>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning toggle-meal-availability-btn" data-meal-id="${m.id}" title="Toggle Availability">
                                        <ion-icon name="power-outline"></ion-icon>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-meal-btn" data-meal-id="${m.id}" title="Delete Meal">
                                        <ion-icon name="trash-outline"></ion-icon>
                                    </button>
                                </div>
                            </td>
                        </tr>`).join('');
                    tbody.innerHTML = rows || `<tr><td colspan="5" class="text-center py-4">No meals for this restaurant</td></tr>`;
                } else {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">${data.error || 'Failed to load meals'}</td></tr>`;
                }
            })
            .catch(()=>{
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">Network error</td></tr>`;
            });
    }

    function refreshMealsByRestaurant() { loadMealsForSelectedRestaurant(); }

    function addMealsByRestaurantEventListeners() {
        const tbody = document.getElementById('mealsByRestaurantTableBody');
        if (tbody && !tbody.dataset.listenersAttached) {
            tbody.addEventListener('click', function(e) {
                const editBtn = e.target.closest('.edit-meal-btn');
                const toggleBtn = e.target.closest('.toggle-meal-availability-btn');
                const deleteBtn = e.target.closest('.delete-meal-btn');
                if (editBtn) {
                    const id = editBtn.getAttribute('data-meal-id');
                    showMealEditModal(id);
                    return;
                }
                if (toggleBtn) {
                    const id = toggleBtn.getAttribute('data-meal-id');
                    toggleMealAvailability(id);
                    return;
                }
                if (deleteBtn) {
                    const id = deleteBtn.getAttribute('data-meal-id');
                    deleteMeal(id);
                    return;
                }
            });
            tbody.dataset.listenersAttached = 'true';
        }
    }
    
    function showMealAnalytics() {
        console.log('ðŸ”„ Showing meal analytics...');
        clearAllContent();
        const content = `
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="fw-bold mb-0">Meal Analytics</h3>
                    <p class="text-body-secondary mb-0">Performance and insights for meals</p>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card border-0 shadow-sm"><div class="card-body d-flex align-items-center">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem">
                            <ion-icon name="fast-food-outline" class="text-white" style="font-size:1.5rem"></ion-icon>
                        </div>
                        <div class="ms-3">
                            <div class="text-body-secondary small">Total Meals</div>
                            <div id="mealsTotal" class="h4 fw-bold mb-0">0</div>
                        </div>
                    </div></div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card border-0 shadow-sm"><div class="card-body d-flex align-items-center">
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem">
                            <ion-icon name="checkmark-circle-outline" class="text-white" style="font-size:1.5rem"></ion-icon>
                        </div>
                        <div class="ms-3">
                            <div class="text-body-secondary small">Available Meals</div>
                            <div id="mealsAvailable" class="h4 fw-bold mb-0">0</div>
                        </div>
                    </div></div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card border-0 shadow-sm"><div class="card-body d-flex align-items-center">
                        <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width:3rem;height:3rem">
                            <ion-icon name="pricetags-outline" class="text-white" style="font-size:1.5rem"></ion-icon>
                        </div>
                        <div class="ms-3">
                            <div class="text-body-secondary small">Average Price</div>
                            <div id="mealsAvgPrice" class="h4 fw-bold mb-0">$0.00</div>
                        </div>
                    </div></div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="fw-bold mb-0"><ion-icon name="trophy-outline" class="me-2"></ion-icon>Top Meals</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Meal</th>
                                            <th>Times Ordered</th>
                                            <th>Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topMealsBody">
                                        <tr>
                                            <td colspan="3" class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        const mainContent = document.querySelector('.admin-content .container-fluid');
        if (mainContent) {
            mainContent.innerHTML = content;
            setTimeout(loadMealAnalytics, 50);
        }
    }

    function loadMealAnalytics() {
        fetch('/admin-api/meals/analytics/', {
            method: 'GET',
            headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type': 'application/json' }
        })
        .then(r=>r.json())
        .then(data=>{
            if (!data.success) { showNotification('Error loading meal analytics: '+(data.error||''), 'error'); return; }
            displayMealAnalytics(data.analytics);
        })
        .catch(()=> showNotification('Network error loading meal analytics', 'error'));
    }

    function displayMealAnalytics(analytics) {
        const totalEl = document.getElementById('mealsTotal');
        const availEl = document.getElementById('mealsAvailable');
        const avgEl = document.getElementById('mealsAvgPrice');
        if (totalEl) totalEl.textContent = analytics.total_meals || 0;
        if (availEl) availEl.textContent = analytics.available_meals || 0;
        if (avgEl) avgEl.textContent = '$' + (parseFloat(analytics.avg_price)||0).toFixed(2);
        const tbody = document.getElementById('topMealsBody');
        if (tbody) {
            const rows = (analytics.top_meals||[]).map(m=>`
                <tr>
                    <td class="fw-medium">${m.name}</td>
                    <td><span class="badge bg-primary">${m.times_ordered}</span></td>
                    <td><span class="fw-bold">$${(parseFloat(m.revenue)||0).toFixed(2)}</span></td>
                </tr>`).join('');
            tbody.innerHTML = rows || `<tr><td colspan="3" class="text-center py-3 text-muted">No meal data available</td></tr>`;
        }
    }
    
    function showMealEditModal(mealId, mealName) {
        // Fetch meal data and show edit modal
        fetch(`/admin-api/meals/${mealId}/edit/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMealEditForm(data.meal);
            } else {
                showNotification(data.error || 'Failed to load meal data', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to load meal data', 'error');
        });
    }
    
    function showMealEditForm(meal) {
        const modalHtml = `
            <div class="modal fade" id="mealEditModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Meal: ${meal.name}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="mealEditForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meal Name</label>
                                        <input type="text" class="form-control" id="editMealName" value="${meal.name}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Price ($)</label>
                                        <input type="number" class="form-control" id="editMealPrice" value="${meal.price}" step="0.01" min="0">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" id="editMealDescription" rows="3">${meal.description || ''}</textarea>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="editMealIsAvailable" ${meal.is_available ? 'checked' : ''}>
                                            <label class="form-check-label">Available for Order</label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveMealEdit(${meal.id})">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('mealEditModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('mealEditModal'));
        modal.show();
    }
    
    function saveMealEdit(mealId) {
        const formData = {
            name: document.getElementById('editMealName').value,
            price: parseFloat(document.getElementById('editMealPrice').value),
            description: document.getElementById('editMealDescription').value,
            is_available: document.getElementById('editMealIsAvailable').checked
        };
        
        fetch(`/admin-api/meals/${mealId}/edit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('mealEditModal'));
                modal.hide();
                // Refresh the page to show updated data
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error || 'Failed to update meal', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to update meal', 'error');
        });
    }
    
    // View Toggle Functions
    function toggleView(viewType) {
        const simpleViewBtn = document.getElementById('simpleViewBtn');
        const comprehensiveViewBtn = document.getElementById('comprehensiveViewBtn');
        const simpleViewSection = document.getElementById('simple-view-section');
        const dashboardSection = document.getElementById('dashboard-section');
        
        if (viewType === 'simple') {
            // Show simple view
            simpleViewSection.style.display = 'block';
            dashboardSection.style.display = 'none';
            
            // Update button states
            simpleViewBtn.classList.remove('btn-outline-primary');
            simpleViewBtn.classList.add('btn-primary');
            comprehensiveViewBtn.classList.remove('btn-primary');
            comprehensiveViewBtn.classList.add('btn-outline-primary');
            
            // Update sidebar to show simple navigation
            updateSidebarForSimpleView();
            
        } else {
            // Show comprehensive view
            simpleViewSection.style.display = 'none';
            dashboardSection.style.display = 'block';
            
            // Update button states
            comprehensiveViewBtn.classList.remove('btn-outline-primary');
            comprehensiveViewBtn.classList.add('btn-primary');
            simpleViewBtn.classList.remove('btn-primary');
            simpleViewBtn.classList.add('btn-outline-primary');
            
            // Update sidebar to show comprehensive navigation
            updateSidebarForComprehensiveView();
        }
    }
    
    function updateSidebarForSimpleView() {
        // Hide detailed management sections in sidebar
        const sidebarLinks = document.querySelectorAll('.admin-nav-link');
        sidebarLinks.forEach(link => {
            const section = link.getAttribute('data-section');
            if (['users', 'orders', 'restaurants', 'meals', 'analytics', 'settings'].includes(section)) {
                link.style.display = 'none';
            }
        });
        
        // Show only overview
        const overviewLink = document.querySelector('[data-section="dashboard"]');
        if (overviewLink) {
            overviewLink.classList.add('active');
        }
    }
    
    function updateSidebarForComprehensiveView() {
        // Show all sidebar links
        const sidebarLinks = document.querySelectorAll('.admin-nav-link');
        sidebarLinks.forEach(link => {
            link.style.display = 'block';
        });
    }
    
    // Section management function
    function showSection(sectionName) {
        console.log('ðŸ”„ Quick action switching to section:', sectionName);
        
        // Use the main showAdminSection function for consistency
        showAdminSection(sectionName);
        
        // If showing a section other than dashboard, switch to comprehensive view
        if (sectionName !== 'dashboard') {
            toggleView('comprehensive');
        }
    }
    
    // Initialize with appropriate view
    document.addEventListener('DOMContentLoaded', function() {
        // Check if simple view is requested
        {% if is_simple_view %}
        toggleView('simple');
        {% else %}
        toggleView('comprehensive');
        {% endif %}
    });
    
    // React to hash changes to switch sections without full refresh
    window.addEventListener('hashchange', function() {
        const hash = (window.location.hash || '').replace('#', '').trim();
        if (hash) {
            showAdminSection(hash);
        }
    });

    function initializeRestaurantCharts(analytics) {
        const series = analytics.restaurants_by_day || [];
        const labels = series.map(p => p.date);
        const counts = series.map(p => p.restaurants);
        const el = document.getElementById('restaurantsOverTimeChart');
        if (!el) return;
        if (el._chartInstance) { try { el._chartInstance.destroy(); } catch(e) {} }
        const chart = new Chart(el, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Restaurants Created', data: counts, borderColor: '#6f42c1', backgroundColor: 'rgba(111,66,193,0.1)', tension: 0.25 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
        });
        el._chartInstance = chart;
    }

    function initializeRestaurantStatusChart(analytics) {
        const el = document.getElementById('restaurantStatusChart');
        if (!el) return;
        const top = analytics.top_restaurants || [];
        // Use top restaurants orders_count as a distribution proxy
        const labels = top.map(r => r.name);
        const data = top.map(r => r.orders_count || 0);
        if (el._chartInstance) { try { el._chartInstance.destroy(); } catch(e) {} }
        const chart = new Chart(el, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545','#6f42c1','#0dcaf0']
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
        el._chartInstance = chart;
    }

    function initializeOrderStatusChart(analytics) {
        const el = document.getElementById('orderStatusChart');
        if (!el) return;
        const dist = analytics.status_distribution || [];
        const labels = dist.map(r => (r.status||'').toString());
        const data = dist.map(r => r.count||0);
        const colors = ['#ffc107','#0dcaf0','#198754','#6c757d','#dc3545','#0d6efd'];
        if (el._chartInstance) { try { el._chartInstance.destroy(); } catch(e) {} }
        const chart = new Chart(el, {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: colors.slice(0, labels.length) }] },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
        el._chartInstance = chart;
    }
</script>
{% endblock %}
